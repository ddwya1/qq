<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLè§’è‰²å¡å›å¡«å·¥å…· - ç»ˆæä¿®å¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); min-height: 100vh; padding: 20px; color: #e2e8f0; font-family: sans-serif; }
        .card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 24px; max-width: 800px; margin: 0 auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .step { background: rgba(15, 23, 42, 0.6); border-left: 4px solid #818cf8; padding: 16px; margin: 16px 0; border-radius: 12px; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #6366f1; color: white; width: 100%; }
        .btn-success { background: #10b981; color: white; width: 100%; }
        .btn-copy { background: #f59e0b; color: white; }
        .btn-small { padding: 8px 14px; font-size: 13px; width: auto; }
        textarea { width: 100%; min-height: 200px; padding: 12px; background: #0f172a; color: #94a3b8; border: 1px solid #334155; border-radius: 10px; font-family: monospace; font-size: 13px; resize: vertical; margin-top: 10px; }
        .upload-zone { border: 2px dashed #475569; border-radius: 16px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { border-color: #818cf8; background: rgba(99, 102, 241, 0.1); }
        .hidden { display: none !important; }
        .segment-box { background: rgba(51, 65, 85, 0.4); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin: 12px 0; }
        .segment-title { font-weight: 700; color: #c7d2fe; margin-bottom: 8px; font-size: 14px; }
        .log { background: #000; color: #4ade80; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px; margin-top: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="card">
    <div style="text-align: center; margin-bottom: 24px;">
        <h1 style="font-size: 24px; font-weight: 900; color: #818cf8;">ğŸ”„ BLè§’è‰²å¡å›å¡«å·¥å…·</h1>
        <p style="color: #94a3b8; font-size: 13px; margin-top: 4px;">[ ä¿®å¤å¯¼å…¥å¤±è´¥ + å®Œç¾ V2 è§„æ ¼ ]</p>
    </div>

    <!-- æ­¥éª¤1 -->
    <div class="step">
        <h2 style="font-weight: 700; margin-bottom: 12px;">ğŸ“ æ­¥éª¤1ï¼šä¸Šä¼ åŸå§‹è§’è‰²å¡</h2>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="hidden" accept=".png,.json" onchange="loadCard(event)">
            <div id="uploadText">
                <div style="font-size: 40px; margin-bottom: 8px;">ğŸ–¼ï¸</div>
                <div style="font-size: 15px; font-weight: 600;">ç‚¹å‡»ä¸Šä¼  PNG æˆ– JSON</div>
            </div>
        </div>
        <div id="cardInfo" class="hidden" style="background: rgba(99, 102, 241, 0.2); padding: 10px; border-radius: 8px; margin-top: 12px; font-size: 13px; color: #c7d2fe;">
            <div id="cardDetails"></div>
        </div>
    </div>

    <!-- æ­¥éª¤2 -->
    <div id="step2" class="step hidden">
        <h2 style="font-weight: 700; margin-bottom: 12px;">ğŸ”€ æ­¥éª¤2ï¼šé€‰æ‹©å¤„ç†æ¨¡å¼</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="selectMode('full')">ğŸ“„ å®Œæ•´å¤„ç†</button>
            <button class="btn btn-primary" onclick="selectMode('segment')">ğŸ“‘ åˆ†æ®µå¤„ç†</button>
        </div>
    </div>

    <!-- æ­¥éª¤3A -->
    <div id="step3Full" class="step hidden">
        <h2 style="font-weight: 700; margin-bottom: 10px;">ğŸ“ ç²˜è´´AIæ”¹å†™ç»“æœ</h2>
        <textarea id="aiResultFull" placeholder="åœ¨æ­¤ç²˜è´´AIçš„å®Œæ•´å›å¤..."></textarea>
        <button class="btn btn-success" onclick="rebuildFull()" style="margin-top: 12px;">ğŸš€ ç”Ÿæˆæ–°è§’è‰²å¡</button>
        <div id="logFull" class="log hidden"></div>
    </div>

    <!-- æ­¥éª¤3B -->
    <div id="step3Segment" class="step hidden">
        <h2 style="font-weight: 700; margin-bottom: 10px;">ğŸ“‘ åˆ†æ®µä»»åŠ¡åˆ—è¡¨</h2>
        <div id="segmentContainer"></div>
        <button class="btn btn-success" onclick="rebuildSegment()" style="margin-top: 16px;">ğŸ”¨ åˆæˆæ–°è§’è‰²å¡</button>
        <div id="logSegment" class="log hidden"></div>
    </div>
</div>

<script>
let originalFullJson = null; 
let cardData = null; 
let cardName = "character";
let segmentList = [];

// ========== æ ¸å¿ƒï¼šä¸‡èƒ½è§£ç å‡½æ•° ==========
function decodeBase64Unicode(str) {
    try {
        const binaryString = window.atob(str);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
        return new TextDecoder('utf-8').decode(bytes);
    } catch (e) { return null; }
}

// ========== æ ¸å¿ƒï¼šJSON ä¸‹è½½ (ç¦æ­¢åŠ  BOM) ==========
function downloadJson(obj, fileName) {
    const content = JSON.stringify(obj, null, 2);
    // JSON ç»å¯¹ä¸èƒ½åŠ  BOMï¼Œå¦åˆ™é…’é¦†ä¼šæŠ¥é”™
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
}

// ========== æ ¸å¿ƒï¼šTXT ä¸‹è½½ (ä¿ç•™ BOM è§£å†³ä¹±ç ) ==========
function downloadTxt(content, fileName) {
    const encoder = new TextEncoder();
    const uint8Array = encoder.encode(content);
    const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
    const finalArray = new Uint8Array(bom.length + uint8Array.length);
    finalArray.set(bom);
    finalArray.set(uint8Array, bom.length);
    const blob = new Blob([finalArray], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
}

async function loadCard(event) {
    const file = event.target.files[0];
    if (!file) return;
    cardName = file.name.replace(/\.(png|json)$/i, '');
    try {
        let rawText;
        if (file.name.toLowerCase().endsWith('.png')) {
            const buffer = await file.arrayBuffer();
            rawText = extractTextFromPNG(new Uint8Array(buffer));
            if (!rawText) throw new Error("PNGä¸­æœªæ‰¾åˆ°æ•°æ®");
            try { JSON.parse(rawText); } catch (e) { rawText = decodeBase64Unicode(rawText); }
        } else {
            rawText = await file.text();
        }
        
        let json = JSON.parse(rawText);
        originalFullJson = json;
        cardData = json.data || json; 
        
        document.getElementById('cardInfo').classList.remove('hidden');
        document.getElementById('cardDetails').innerHTML = 'âœ… å·²åŠ è½½è§’è‰²: <strong>' + (cardData.name || 'æœªçŸ¥') + '</strong>';
        document.getElementById('step2').classList.remove('hidden');
    } catch (e) { alert('è§£æå¤±è´¥: ' + e.message); }
}

function selectMode(mode) {
    document.getElementById('step3Full').classList.toggle('hidden', mode !== 'full');
    document.getElementById('step3Segment').classList.toggle('hidden', mode !== 'segment');
    if (mode === 'segment') generateSegments();
}

function generateSegments() {
    const container = document.getElementById('segmentContainer');
    container.innerHTML = ''; segmentList = [];
    const basicFields = ['description', 'personality', 'scenario', 'first_mes', 'mes_example', 'system_prompt', 'post_history_instructions'];
    segmentList.push({ id: 'basic', title: 'åŸºç¡€ä¿¡æ¯', fields: basicFields });
    const alts = cardData.alternate_greetings || [];
    for (let i = 0; i < alts.length; i += 5) segmentList.push({ id: 'alt_'+i, title: 'å¤‡ç”¨å¼€åœºç™½ '+(i+1)+'-'+Math.min(i+5, alts.length), altStart: i, altEnd: Math.min(i+5, alts.length) });
    const books = cardData.character_book?.entries || cardData.lorebook?.entries || [];
    for (let i = 0; i < books.length; i += 10) segmentList.push({ id: 'book_'+i, title: 'ä¸–ç•Œä¹¦æ¡ç›® '+(i+1)+'-'+Math.min(i+10, books.length), bookStart: i, bookEnd: Math.min(i+10, books.length) });

    segmentList.forEach(seg => {
        const div = document.createElement('div');
        div.className = 'segment-box';
        div.innerHTML = '<div class="segment-title">'+seg.title+'</div>' +
            '<div style=\"display:flex; gap:8px;\"><button class=\"btn btn-copy btn-small\" onclick=\"copySeg(\''+seg.id+'\', this)\">ğŸ“‹ å¤åˆ¶ä»»åŠ¡</button>' +
            '<button class=\"btn btn-primary btn-small\" onclick=\"dlSeg(\''+seg.id+'\')\">ğŸ“¥ ä¸‹è½½</button></div>' +
            '<textarea id=\"res_'+seg.id+'\" placeholder=\"åœ¨æ­¤ç²˜è´´è¯¥æ®µæ”¹å†™ç»“æœ...\"></textarea>';
        container.appendChild(div);
    });
}

function getSegContent(id) {
    const seg = segmentList.find(s => s.id === id);
    let content = 'ã€æŒ‡ä»¤ã€‘ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„BLå°è¯´æ”¹å†™åŠ©æ‰‹ã€‚è¯·è¯»å–ä¸‹æ–¹çš„è§’è‰²å¡æ•°æ®ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹ä¿®æ”¹ä»»åŠ¡ï¼š\n' +
                  '1. ã€æ ¸å¿ƒä»»åŠ¡ã€‘ï¼šå°†Userçš„æ€§åˆ«è®¾å®šä¸ºã€ç”·æ€§ã€‘ï¼Œå°†æŒ‡ä»£Userçš„ä»£è¯æ”¹ä¸º"ä»–"ã€‚\n' +
                  '2. ã€NSFW/ç”Ÿç†ä¿®æ­£ã€‘ï¼šè¯†åˆ«è¿™æ˜¯ä¸¤ä¸ªç”·æ€§çš„äº’åŠ¨ã€‚ä¿®æ”¹å™¨å®˜å’ŒåŠ¨ä½œï¼ˆä¾‹å¦‚ï¼šåç©´ã€è‚ æ¶²ã€å‰åˆ—è…ºã€å‹ƒèµ·ç­‰ï¼‰ã€‚\n' +
                  '3. ã€æ ¼å¼æ­»å‘½ä»¤ã€‘ï¼šä¸¥ç¦åˆ é™¤æ¢è¡Œç¬¦ï¼å¿…é¡»ä¿ç•™æ‰€æœ‰ ### ã€æ ‡é¢˜ã€‘ æ ¼å¼ï¼\n\n' +
                  '==================== å¾…ä¿®æ”¹å†…å®¹ ====================\n\n';

    if (seg.fields) {
        const map = { description:'è§’è‰²æè¿° description', personality:'æ€§æ ¼ personality', scenario:'åœºæ™¯ scenario', first_mes:'å¼€åœºç™½ first_mes', mes_example:'å¯¹è¯ç¤ºä¾‹ mes_example', system_prompt:'ç³»ç»Ÿæç¤º system_prompt', post_history_instructions:'åæŒ‡ä»¤ post_history_instructions' };
        seg.fields.forEach(f => { if(cardData[f]) content += '### ã€'+map[f]+'ã€‘\n'+cardData[f]+'\n\n--------------------\n\n'; });
    }
    if (seg.altStart !== undefined) {
        for(let i=seg.altStart; i<seg.altEnd; i++) content += '### ã€å¤‡ç”¨å¼€åœºç™½ #'+(i+1)+'ã€‘\n'+cardData.alternate_greetings[i]+'\n\n--------------------\n\n';
    }
    if (seg.bookStart !== undefined) {
        const books = cardData.character_book?.entries || cardData.lorebook?.entries || [];
        for(let i=seg.bookStart; i<seg.bookEnd; i++) {
            const e = books[i];
            content += '### ã€ä¸–ç•Œä¹¦æ¡ç›®: '+(e.comment || e.keys?.[0] || i)+'ã€‘\n'+e.content+'\n\n--------------------\n\n';
        }
    }
    return content;
}

function copySeg(id, btn) {
    const text = getSegContent(id);
    const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el);
    el.select(); document.execCommand('copy'); document.body.removeChild(el);
    const old = btn.innerHTML; btn.innerHTML = 'âœ… å·²å¤åˆ¶'; setTimeout(() => btn.innerHTML = old, 1500);
}

function dlSeg(id) { downloadTxt(getSegContent(id), cardName + '_åˆ†æ®µ.txt'); }

function rebuildFull() {
    const text = document.getElementById('aiResultFull').value;
    const log = document.getElementById('logFull'); log.classList.remove('hidden');
    const finalJson = processText(text, log);
    if (finalJson) downloadJson(finalJson, cardName + '_BLç‰ˆ.json');
}

function rebuildSegment() {
    let combinedText = '';
    segmentList.forEach(seg => { combinedText += document.getElementById('res_'+seg.id).value + '\n\n'; });
    const log = document.getElementById('logSegment'); log.classList.remove('hidden');
    const finalJson = processText(combinedText, log);
    if (finalJson) downloadJson(finalJson, cardName + '_BLç‰ˆ.json');
}

function processText(aiText, logBox) {
    let count = 0;
    const newData = JSON.parse(JSON.stringify(cardData));

    function ext(pattern) {
        // æè‡´ä¼˜åŒ–æ­£åˆ™ï¼šç¡®ä¿ä¸æŠ“å–æ ‡é¢˜æœ«å°¾çš„ ã€‘ ç¬¦å·
        const r = new RegExp('###\\s*ã€(?:' + pattern + ')[^ã€‘]*ã€‘\\s*\\n?([\\s\\S]*?)(?=\\n###|\\n-{10,}|$)', 'i');
        const m = aiText.match(r);
        if (m && m[1]) { 
            count++; 
            return m[1].trim(); 
        }
        return null;
    }

    const basics = { description:'è§’è‰²æè¿°|description', first_mes:'å¼€åœºç™½|first_mes', personality:'æ€§æ ¼|personality', scenario:'åœºæ™¯|scenario', mes_example:'å¯¹è¯ç¤ºä¾‹|mes_example', system_prompt:'ç³»ç»Ÿæç¤º|system_prompt', post_history_instructions:'åæŒ‡ä»¤|post_history' };
    for (let [k, p] of Object.entries(basics)) { const c = ext(p); if(c) newData[k] = c; }
    
    if (newData.alternate_greetings) {
        for (let i=0; i<newData.alternate_greetings.length; i++) { 
            const c = ext('å¤‡ç”¨å¼€åœºç™½\\s*#'+(i+1)); if(c) newData.alternate_greetings[i] = c; 
        }
    }
    
    const books = newData.character_book?.entries || newData.lorebook?.entries || [];
    books.forEach((e, i) => {
        let c = ext('ä¸–ç•Œä¹¦æ¡ç›®[ï¼š:]\\s*'+(e.comment || ''));
        if(!c) c = ext('ä¸–ç•Œä¹¦æ¡ç›®[ï¼š:]\\s*'+(e.keys?.[0] || ''));
        if(c) e.content = c;
    });

    logBox.innerHTML = 'æˆåŠŸæ›´æ–° ' + count + ' ä¸ªå­—æ®µï¼\nè§„æ ¼éªŒè¯ï¼šSillyTavern V2 æ ‡å‡†';
    
    // è¿”å›æ ‡å‡† V2 ç»“æ„
    return {
        spec: "chara_card_v2",
        spec_version: "2.0",
        data: newData
    };
}

function extractTextFromPNG(u8) {
    let p = 8; const dec = new TextDecoder();
    while (p < u8.length) {
        const len = new DataView(u8.buffer).getUint32(p);
        const type = dec.decode(u8.slice(p+4, p+8));
        if (type === 'tEXt' || type === 'iTXt') {
            const d = u8.slice(p+8, p+8+len);
            const s = d.indexOf(0);
            const keyword = dec.decode(d.slice(0, s));
            if (keyword === 'chara') {
                return type === 'tEXt' ? dec.decode(d.slice(s+1)) : new TextDecoder('utf-8').decode(d.slice(s+3));
            }
        }
        p += 12 + len;
    }
    return null;
}
</script>
</body>
</html>
