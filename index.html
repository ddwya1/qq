<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§’è‰²å¡æ‰“åŒ…åŠ©æ‰‹ (AIä¸“ç”¨ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #09090b; color: #e4e4e7; font-family: sans-serif; padding-bottom: 40px; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            position: sticky; top: 0; z-index: 50;
            background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid #27272a;
            padding: 12px 16px;
            display: flex; justify-content: center; align-items: center;
        }
        .nav-title { font-weight: 800; font-size: 1.1rem; color: #a78bfa; }
        
        /* å¯¼å‡ºåŒºåŸŸ */
        .export-box {
            background: #18181b; border: 1px solid #8b5cf6; 
            border-radius: 12px; padding: 16px; margin: 16px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.15);
        }

        /* æŒ‰é’® */
        .btn {
            display: flex; justify-content: center; align-items: center;
            padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 15px;
            border: none; cursor: pointer; transition: transform 0.1s; width: 100%;
            margin-top: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-purple { background: #7c3aed; color: white; }
        .btn-copy-sm { background: #374151; color: white; padding: 4px 10px; font-size: 12px; width: auto; }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: #18181b; border: 1px solid #27272a; border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
        .card-header { 
            background: #27272a; padding: 10px 14px; font-size: 13px; font-weight: bold; color: #a1a1aa; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .text-content {
            background: #09090b; color: #d4d4d8; padding: 14px; 
            font-family: monospace; font-size: 13px; line-height: 1.6;
            white-space: pre-wrap; word-break: break-all;
            border-top: 1px solid #27272a;
        }

        .upload-box { 
            border: 2px dashed #3f3f46; border-radius: 12px; padding: 40px 20px; 
            text-align: center; color: #71717a; margin: 16px; 
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-title">ğŸ§¬ è§’è‰²å¡æ‰“åŒ…åŠ©æ‰‹</div>
    </div>

    <!-- 1. å¯¼å‡ºåŒºåŸŸ (é»˜è®¤éšè—ï¼Œä¸Šä¼ åæ˜¾ç¤º) -->
    <div id="exportArea" class="hidden">
        <div class="export-box">
            <div class="text-sm font-bold text-purple-400 mb-2">ğŸš€ å‡†å¤‡å°±ç»ª</div>
            <p class="text-xs text-gray-400 mb-3">å·²æå–æ‰€æœ‰å†…å®¹å¹¶é™„å¸¦ BL/NSFW æ”¹å†™æŒ‡ä»¤</p>
            <button class="btn btn-purple" onclick="downloadForAI()">ğŸ“¥ ä¸‹è½½ TXT å‘ç»™ AI</button>
            <p class="text-[10px] text-gray-500 mt-2">æç¤ºï¼šä¸‹è½½åç›´æ¥æŠŠæ–‡ä»¶æ‹–ç»™ ChatGPT/Claude å³å¯</p>
        </div>
    </div>

    <!-- 2. ä¸Šä¼ åŒºåŸŸ -->
    <div id="dropZone" class="upload-box" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" class="hidden" accept=".png,.json" onchange="handleFile(this.files[0])">
        <div class="text-4xl mb-2">ğŸ“‚</div>
        <div class="text-sm">ç‚¹å‡»ä¸Šä¼ è§’è‰²å¡ (PNG/JSON)</div>
    </div>

    <!-- 3. å†…å®¹é¢„è§ˆåˆ—è¡¨ -->
    <div id="contentArea" class="hidden px-4 pb-10">
        <div class="text-xs font-bold text-gray-500 mb-2 mt-4 uppercase">é¢„è§ˆå†…å®¹ (å¯å•ç‹¬å¤åˆ¶)</div>
        <div id="charContainer"></div>

        <div class="flex justify-between items-end mb-2 mt-6">
            <div class="text-xs font-bold text-gray-500 uppercase">ä¸–ç•Œä¹¦ / çŸ¥è¯†åº“</div>
            <div id="worldCount" class="text-xs text-gray-600"></div>
        </div>
        <div id="worldContainer"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨è§£æåçš„æ•°æ®
        let globalData = null;
        let globalFileName = "character";

        // --- æ ¸å¿ƒï¼šæ‰“åŒ…ä¸‹è½½åŠŸèƒ½ ---
        function downloadForAI() {
            if (!globalData) return alert('æ²¡æœ‰æ•°æ®');

            // 1. å‡†å¤‡æç¤ºè¯ (BL/NSFW ä¸“ç”¨)
            let content = `ã€æŒ‡ä»¤ã€‘ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„BLå°è¯´æ”¹å†™åŠ©æ‰‹ã€‚è¯·è¯»å–ä¸‹æ–¹çš„è§’è‰²å¡æ•°æ®ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹ä¿®æ”¹ä»»åŠ¡ï¼š
1. ã€æ ¸å¿ƒä»»åŠ¡ã€‘ï¼šå°†Userçš„æ€§åˆ«è®¾å®šä¸ºã€ç”·æ€§ã€‘ï¼Œå°†æŒ‡ä»£Userçš„ä»£è¯æ”¹ä¸ºâ€œä»–â€ã€‚
2. ã€NSFW/ç”Ÿç†ä¿®æ­£ã€‘ï¼š
   - è¯†åˆ«è¿™æ˜¯ä¸¤ä¸ªç”·æ€§çš„äº’åŠ¨ã€‚
   - å¦‚æœæ–‡ä¸­æœ‰è‰²æƒ…/äº²å¯†æå†™ï¼Œå¿…é¡»æ ¹æ®ã€ç”·æ€§ç”Ÿç†æ„é€ ã€‘ä¿®æ”¹å™¨å®˜å’ŒåŠ¨ä½œï¼ˆä¾‹å¦‚ï¼šå°†å¥³æ€§ç‰¹å¾æ”¹ä¸ºåç©´ã€è‚ æ¶²ã€å‰åˆ—è…ºã€å‹ƒèµ·ç­‰ï¼‰ã€‚
   - å¦‚æœæ²¡æœ‰è‰²æƒ…å†…å®¹ï¼Œåˆ™åªä¿®æ”¹æ€§åˆ«ä»£è¯ã€‚
3. ã€æ ¼å¼æ­»å‘½ä»¤ã€‘ï¼š
   - å¿…é¡»ä¿ç•™æ‰€æœ‰çš„ XML æ ‡ç­¾ï¼ˆå¦‚ <tag>ï¼‰å’Œåˆ—è¡¨ç¬¦å·ã€‚
   - ä¸¥ç¦åˆ é™¤æ¢è¡Œç¬¦ï¼ä¸¥ç¦åˆå¹¶æ®µè½ï¼
   - è¯·æŒ‰é¡ºåºè¾“å‡ºä¿®æ”¹åçš„å†…å®¹ï¼Œå¹¶ä¿ç•™åŸæ¥çš„ã€æ ‡é¢˜ã€‘ä»¥ä¾¿æˆ‘åŒºåˆ†ã€‚

==================== ä»¥ä¸‹æ˜¯å¾…ä¿®æ”¹å†…å®¹ ====================

`;

            // 2. æ‹¼æ¥è§’è‰²åŸºç¡€ä¿¡æ¯
            const map = [
                ['description','ã€è§’è‰²æè¿° descriptionã€‘'], 
                ['first_mes','ã€å¼€åœºç™½ first_mesã€‘'], 
                ['personality','ã€æ€§æ ¼ personalityã€‘'], 
                ['scenario','ã€åœºæ™¯ scenarioã€‘'], 
                ['mes_example','ã€å¯¹è¯ç¤ºä¾‹ mes_exampleã€‘'], 
                ['system_prompt','ã€ç³»ç»Ÿæç¤º system_promptã€‘'], 
                ['post_history_instructions','ã€åæŒ‡ä»¤ post_historyã€‘']
            ];

            map.forEach(item => {
                if (globalData[item[0]]) {
                    content += `\n### \({item[1]}\n\){globalData[item[0]]}\n\n----------------------------------------\n`;
                }
            });

            // 3. æ‹¼æ¥å¤‡ç”¨å¼€åœºç™½
            if (globalData.alternate_greetings) {
                globalData.alternate_greetings.forEach((v, i) => {
                    content += `\n### ã€å¤‡ç”¨å¼€åœºç™½ #\({i+1}ã€‘\n\){v}\n\n----------------------------------------\n`;
                });
            }

            // 4. æ‹¼æ¥ä¸–ç•Œä¹¦
            let books = [];
            if (globalData.character_book && globalData.character_book.entries) books = globalData.character_book.entries;
            
            if (books.length > 0) {
                content += `\n\n========== ä¸–ç•Œä¹¦ / çŸ¥è¯†åº“æ¡ç›® ==========\n`;
                books.forEach((e, i) => {
                    if (!e.content) return;
                    const title = e.comment || (e.keys ? `Keys: \({e.keys.join(', ')}` : `Entry #\){i+1}`);
                    content += `\n### ã€ä¸–ç•Œä¹¦æ¡ç›®: \({title}ã€‘\n\){e.content}\n\n----------------------------------------\n`;
                });
            }

            // 5. è§¦å‘ä¸‹è½½
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${globalFileName}_æ”¹å†™ä»»åŠ¡åŒ….txt`; // ä½¿ç”¨ .txt ç¡®ä¿å…¼å®¹æ€§
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- æ–‡ä»¶å¤„ç†é€»è¾‘ ---
        function handleFile(file) {
            if (!file) return;
            globalFileName = file.name.replace(/\.[^/.]+$/, ""); // å»æ‰åç¼€
            const reader = new FileReader();
            reader.onload = function(e) {
                const d = e.target.result;
                if (file.name.toLowerCase().endsWith('.png')) {
                    const txt = extractPng(new Uint8Array(d));
                    if (!txt) return alert('æ— æ•ˆ PNG');
                    parseData(txt);
                } else {
                    parseData(d);
                }
            };
            if (file.name.toLowerCase().endsWith('.png')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function parseData(str) {
            try {
                let d;
                try { d = JSON.parse(str); } 
                catch (e) { 
                    const b = atob(str); 
                    const arr = new Uint8Array(b.length);
                    for(let i=0; i<b.length; i++) arr[i] = b.charCodeAt(i);
                    d = JSON.parse(new TextDecoder('utf-8').decode(arr));
                }
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›å¯¼å‡ºä½¿ç”¨
                globalData = d.data || d;
                
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                document.getElementById('exportArea').classList.remove('hidden'); // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
                
                const cBox = document.getElementById('charContainer'); cBox.innerHTML = '';
                const wBox = document.getElementById('worldContainer'); wBox.innerHTML = '';

                // æ¸²æŸ“é¢„è§ˆç•Œé¢ (ä¿ç•™åŸæ¥çš„å¡ç‰‡åŠŸèƒ½ï¼Œæ–¹ä¾¿å•ç‹¬å¤åˆ¶)
                const map = [['description','æè¿°'], ['first_mes','å¼€åœºç™½'], ['personality','æ€§æ ¼'], ['scenario','åœºæ™¯'], ['mes_example','ç¤ºä¾‹'], ['system_prompt','ç³»ç»Ÿæç¤º'], ['post_history_instructions','åæŒ‡ä»¤']];
                
                map.forEach(item => {
                    if (globalData[item[0]]) addCard(cBox, item[1], globalData[item[0]]);
                });

                if (globalData.alternate_greetings) {
                    globalData.alternate_greetings.forEach((v,i) => addCard(cBox, 'å¤‡ç”¨ #'+(i+1), v));
                }
                if (globalData.group_only_greetings) {
                    globalData.group_only_greetings.forEach((v,i) => addCard(cBox, 'ç¾¤èŠ #'+(i+1), v));
                }

                let books = [];
                if (globalData.character_book && globalData.character_book.entries) books = globalData.character_book.entries;
                
                document.getElementById('worldCount').innerText = books.length + ' æ¡ç›®';
                
                books.forEach((e,i) => {
                    if (!e.content) return;
                    const t = e.comment || (e.keys ? 'Keys: '+e.keys.join(', ') : '#'+(i+1));
                    addCard(wBox, t, e.content);
                });

            } catch(e) { console.error(e); alert('è§£æå¤±è´¥: ' + e.message); }
        }

        function addCard(box, title, text) {
            const div = document.createElement('div'); div.className = 'card';
            
            const header = document.createElement('div'); header.className = 'card-header';
            const span = document.createElement('span'); span.className = 'truncate mr-2'; span.innerText = title;
            const btn = document.createElement('button'); 
            btn.className = 'btn btn-copy-sm'; 
            btn.innerText = 'å¤åˆ¶';
            btn.onclick = function() { copy(this); };

            header.appendChild(span); header.appendChild(btn);

            const body = document.createElement('div'); body.className = 'card-body';
            const txtDiv = document.createElement('div'); txtDiv.className = 'text-content';
            txtDiv.innerText = text;

            body.appendChild(txtDiv);
            div.appendChild(header); div.appendChild(body);
            box.appendChild(div);
        }

        function copy(btn) {
            const txt = btn.parentElement.nextElementSibling.innerText;
            navigator.clipboard.writeText(txt).then(() => {
                const old = btn.innerText; btn.innerText = 'OK';
                setTimeout(() => btn.innerText = old, 1000);
            });
        }

        function extractPng(buf) {
            const view = new DataView(buf.buffer); let p=8; const dec = new TextDecoder('utf-8');
            while(p < buf.length) {
                const len = view.getUint32(p); 
                const type = dec.decode(buf.slice(p+4, p+8));
                if(type === 'tEXt' || type === 'iTXt') {
                    const d = buf.slice(p+8, p+8+len); 
                    const split = d.indexOf(0);
                    if(dec.decode(d.slice(0, split)) === 'chara') {
                        if (type === 'tEXt') return dec.decode(d.slice(split+1));
                        else {
                            let p2 = split + 3;
                            while (p2 < d.length && d[p2] !== 0) p2++; p2++;
                            while (p2 < d.length && d[p2] !== 0) p2++; p2++;
                            return dec.decode(d.slice(p2));
                        }
                    }
                }
                p += 12+len;
            }
            return null;
        }
    </script>
</body>
</html>
