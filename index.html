<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SillyTavern è§’è‰²å¡æ€§åˆ«è½¬æ¢å·¥å…· (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        :root { --glass-bg: rgba(30, 30, 40, 0.95); --glass-border: rgba(255, 255, 255, 0.1); --accent-pink: #ff6b9d; --accent-blue: #4fc3f7; --accent-purple: #b388ff; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%); min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 16px; }
        .glass-input, .glass-select { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: white; transition: all 0.3s ease; }
        .glass-input:focus, .glass-select:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 20px rgba(179, 136, 255, 0.3); }
        .glass-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; padding-right: 40px; }
        .glass-select option { background: #1a1a2e; color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple)); border: none; border-radius: 12px; color: white; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .btn-warning { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; border-radius: 12px; font-weight: 600; transition: all 0.3s ease; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; transition: all 0.3s ease; }
        .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.15); }
        .btn-icon { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: white; padding: 8px 12px; transition: all 0.3s ease; font-size: 14px; }
        .toggle-btn { position: relative; background: rgba(255, 255, 255, 0.1); border-radius: 25px; padding: 4px; display: flex; gap: 4px; }
        .toggle-option { padding: 10px 20px; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; z-index: 1; }
        .toggle-option.active { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; }
        .toggle-option:not(.active) { color: rgba(255, 255, 255, 0.6); }
        .file-drop-zone { border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 16px; transition: all 0.3s ease; cursor: pointer; }
        .file-drop-zone:hover, .file-drop-zone.dragover { border-color: var(--accent-purple); background: rgba(179, 136, 255, 0.1); }
        .progress-bar { height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-pink), var(--accent-purple)); transition: width 0.3s ease; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; z-index: 9999; animation: slideIn 0.3s ease; max-width: calc(100vw - 40px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.success { background: linear-gradient(135deg, #00c853, #00bfa5); }
        .toast.error { background: linear-gradient(135deg, #ff5252, #ff1744); }
        .toast.info { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .diff-added { background: rgba(0, 200, 83, 0.3); color: #69f0ae; padding: 2px 4px; border-radius: 4px; }
        .diff-removed { background: rgba(255, 82, 82, 0.3); color: #ff8a80; padding: 2px 4px; border-radius: 4px; text-decoration: line-through; }
        .preview-section { max-height: 300px; overflow-y: auto; }
        .card-preview-img { max-width: 120px; max-height: 160px; border-radius: 12px; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.2); }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; flex-shrink: 0; }
        .status-indicator.pending { background: #ffd54f; }
        .status-indicator.processing { background: var(--accent-blue); animation: pulse 1s infinite; }
        .status-indicator.done { background: #69f0ae; }
        .status-indicator.error { background: #ff5252; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .field-item { background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .collapsible-content.open { max-height: 2000px; }
        .chevron { transition: transform 0.3s ease; }
        .chevron.open { transform: rotate(180deg); }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { font-size: 0.75rem; color: #ff8a80; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; display: inline-block; vertical-align: middle; }
    </style>
</head>
<body class="text-white p-4 pb-20">
    <div class="max-w-2xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 bg-clip-text text-transparent">
                ğŸ­ è§’è‰²å¡æ€§åˆ«è½¬æ¢å·¥å…· Pro
            </h1>
            <p class="text-gray-400 text-sm mt-2">å¹¶å‘åŠ é€Ÿ Â· æš‚åœç»­ä¼  Â· é”™è¯¯é‡è¯•</p>
        </div>

        <div class="glass p-4 mb-4">
            <div class="collapsible-header" onclick="toggleCollapsible('api-settings')">
                <h2 class="text-lg font-semibold flex items-center">
                    <span class="mr-2">âš™ï¸</span> API è®¾ç½®
                </h2>
                <span class="chevron" id="api-settings-chevron">â–¼</span>
            </div>
            <div class="collapsible-content open" id="api-settings">
                <div class="mt-4 space-y-3">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">API URL</label>
                        <input type="text" id="apiUrl" class="glass-input w-full px-4 py-3 text-sm" placeholder="https://api.openai.com/v1" value="https://api.deepseek.com/v1" onchange="clearModelList()">
                        <p class="text-xs text-gray-500 mt-1">ğŸ’¡ è‡ªåŠ¨è¡¥å…¨ /chat/completions</p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">API Key</label>
                        <input type="password" id="apiKey" class="glass-input w-full px-4 py-3 text-sm" placeholder="sk-xxxxxxxxxxxxxxxx" onchange="clearModelList()">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">é€‰æ‹©æ¨¡å‹</label>
                        <div class="flex gap-2">
                            <select id="modelSelect" class="glass-select flex-1 px-4 py-3 text-sm" disabled>
                                <option value="">è¯·å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨</option>
                            </select>
                            <button id="loadModelsBtn" class="btn-icon whitespace-nowrap" onclick="loadModels()">ğŸ”„ åŠ è½½</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass p-4 mb-4">
            <h2 class="text-lg font-semibold mb-3 flex items-center">
                <span class="mr-2">ğŸ¯</span> ç›®æ ‡æ€§åˆ«
            </h2>
            <div class="toggle-btn">
                <div class="toggle-option active" id="toggle-male" onclick="setTargetGender('male')">â™‚ï¸ è½¬ä¸ºç”·æ€§ User</div>
                <div class="toggle-option" id="toggle-female" onclick="setTargetGender('female')">â™€ï¸ è½¬ä¸ºå¥³æ€§ User</div>
            </div>
        </div>

        <div class="glass p-4 mb-4">
            <h2 class="text-lg font-semibold mb-3 flex items-center">
                <span class="mr-2">ğŸ“</span> å¯¼å…¥è§’è‰²å¡
            </h2>
            <div class="file-drop-zone p-8 text-center" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" class="hidden" accept=".png,.json" onchange="handleFileSelect(event)">
                <div class="text-4xl mb-3">ğŸ“¤</div>
                <p class="text-gray-300">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
            </div>
            <div id="cardPreview" class="hidden mt-4">
                <div class="flex items-start gap-4">
                    <img id="previewImage" class="card-preview-img" src="" alt="Card Preview">
                    <div class="flex-1 min-w-0">
                        <h3 id="cardName" class="font-semibold text-lg truncate"></h3>
                        <p id="cardCreator" class="text-sm text-gray-400"></p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            <span class="text-xs px-2 py-1 bg-purple-500/20 rounded-full" id="cardSpec"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è½¬æ¢æ§åˆ¶åŒºåŸŸ -->
        <div id="controlPanel" class="hidden mb-4 grid grid-cols-2 gap-3">
            <button id="pauseBtn" class="btn-secondary py-3 text-lg font-semibold" onclick="togglePause()">â¸ï¸ æš‚åœ</button>
            <button id="retryBtn" class="btn-warning py-3 text-lg font-semibold hidden" onclick="retryFailed()">ğŸ”„ é‡è¯•å¤±è´¥é¡¹</button>
        </div>

        <button id="convertBtn" class="btn-primary w-full py-4 text-lg mb-4" onclick="initConversion()" disabled>ğŸš€ å¼€å§‹æé€Ÿè½¬æ¢</button>

        <div id="progressSection" class="glass p-4 mb-4 hidden">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold flex items-center"><span class="mr-2">â³</span> è½¬æ¢è¿›åº¦</h2>
                <span id="progressCount" class="text-xs text-gray-400">0/0</span>
            </div>
            <div class="progress-bar mb-3">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="progressStatus" class="text-sm text-gray-400 mb-2">å‡†å¤‡å°±ç»ª...</div>
            <div id="fieldProgress" class="mt-3 max-h-60 overflow-y-auto pr-1"></div>
        </div>

        <div id="diffSection" class="glass p-4 mb-4 hidden">
            <h2 class="text-lg font-semibold mb-3 flex items-center"><span class="mr-2">ğŸ“</span> ä¿®æ”¹é¢„è§ˆ</h2>
            <div id="diffContent" class="space-y-4"></div>
        </div>

        <div id="exportSection" class="glass p-4 hidden">
            <h2 class="text-lg font-semibold mb-3 flex items-center"><span class="mr-2">ğŸ’¾</span> å¯¼å‡ºæ–‡ä»¶</h2>
            <div class="grid grid-cols-2 gap-3">
                <button class="btn-primary py-3" onclick="exportPNG()">ğŸ“¥ ä¸‹è½½ PNG</button>
                <button class="btn-secondary py-3" onclick="exportJSON()">ğŸ“„ ä¸‹è½½ JSON</button>
            </div>
        </div>
        
        <div class="text-center text-gray-500 text-xs mt-8">
            <p>Made with â¤ï¸ for SillyTavern Community</p>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        var state = {
            targetGender: 'male',
            originalData: null,
            convertedData: null,
            originalPngBuffer: null,
            originalFileName: '',
            cardImageDataUrl: '',
            availableModels: [],
            
            // ä»»åŠ¡æ§åˆ¶
            isProcessing: false,
            isPaused: false,
            tasks: [], // æ‰€æœ‰ä»»åŠ¡å¯¹è±¡
            activeTasks: 0,
            maxConcurrency: 5, // æœ€å¤§å¹¶å‘æ•°
            completedCount: 0,
            totalCount: 0
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        function showToast(message, type, duration) {
            type = type || 'info';
            duration = duration || 3000;
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(function() { toast.remove(); }, 300);
            }, duration);
        }

        function toggleCollapsible(id) {
            var content = document.getElementById(id);
            var chevron = document.getElementById(id + '-chevron');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        function getBaseUrl(url) {
            return url.replace(/\/\(/, '').replace(/\/chat\/completions\)/, '');
        }

        function getChatUrl(url) {
            url = url.replace(/\/$/, '');
            if (url.endsWith('/chat/completions')) return url;
            return url + '/chat/completions';
        }

        // ==================== æ ¸å¿ƒé€»è¾‘ ====================
        function setTargetGender(gender) {
            state.targetGender = gender;
            document.getElementById('toggle-male').classList.toggle('active', gender === 'male');
            document.getElementById('toggle-female').classList.toggle('active', gender === 'female');
        }

        function clearModelList() {
            var select = document.getElementById('modelSelect');
            select.innerHTML = '';
            var opt = document.createElement('option');
            opt.value = ""; opt.textContent = "è¯·å…ˆåŠ è½½æ¨¡å‹åˆ—è¡¨";
            select.appendChild(opt);
            select.disabled = true;
            state.availableModels = [];
        }

        function loadModels() {
            var apiUrl = document.getElementById('apiUrl').value.trim();
            var apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiUrl || !apiKey) { showToast('è¯·å…ˆå¡«å†™ API URL å’Œ API Key', 'error'); return; }
            
            var btn = document.getElementById('loadModelsBtn');
            var originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'åŠ è½½ä¸­<span class="spinner"></span>';
            
            var modelsUrl = getBaseUrl(apiUrl) + '/models';
            
            fetch(modelsUrl, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' }
            }).then(function(res) {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            }).then(function(data) {
                if (!data.data || !Array.isArray(data.data)) throw new Error('æ ¼å¼é”™è¯¯');
                state.availableModels = data.data.filter(function(m) { return m.id; }).sort(function(a, b) {
                    var aIsChat = a.id.toLowerCase().indexOf('chat') !== -1;
                    var bIsChat = b.id.toLowerCase().indexOf('chat') !== -1;
                    return (aIsChat && !bIsChat) ? -1 : (!aIsChat && bIsChat) ? 1 : a.id.localeCompare(b.id);
                });
                
                var select = document.getElementById('modelSelect');
                select.innerHTML = '';
                state.availableModels.forEach(function(m) {
                    var opt = document.createElement('option');
                    opt.value = m.id; opt.textContent = m.id;
                    select.appendChild(opt);
                });
                select.disabled = false;
                if (state.availableModels.length > 0) select.value = state.availableModels[0].id;
                
                showToast('åŠ è½½æˆåŠŸ', 'success');
                updateConvertButtonState();
            }).catch(function(err) {
                showToast('åŠ è½½å¤±è´¥: ' + err.message, 'error');
                clearModelList();
            }).finally(function() {
                btn.disabled = false; btn.innerHTML = originalText;
            });
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        var dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', function(e) { e.preventDefault(); dropZone.classList.remove('dragover'); var f = e.dataTransfer.files[0]; if(f) processFile(f); });
        
        function handleFileSelect(e) { var f = e.target.files[0]; if(f) processFile(f); }

        function processFile(file) {
            state.originalFileName = file.name.replace(/\.(png|json)$/i, '');
            var reader = new FileReader();
            
            if (file.name.toLowerCase().endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        state.originalData = JSON.parse(e.target.result);
                        state.cardImageDataUrl = '';
                        onFileLoaded();
                    } catch(err) { showToast('JSON è§£æå¤±è´¥', 'error'); }
                };
                reader.readAsText(file);
            } else if (file.name.toLowerCase().endsWith('.png')) {
                reader.onload = function(e) {
                    try {
                        state.originalPngBuffer = new Uint8Array(e.target.result);
                        state.cardImageDataUrl = URL.createObjectURL(file);
                        var charaData = extractCharaFromPNG(state.originalPngBuffer);
                        if (!charaData) throw new Error('æ— è§’è‰²æ•°æ®');
                        
                        try {
                            var jsonStr = atob(charaData);
                            try { jsonStr = decodeURIComponent(escape(jsonStr)); } catch(e){}
                            state.originalData = JSON.parse(jsonStr);
                        } catch(e) { state.originalData = JSON.parse(atob(charaData)); }
                        
                        onFileLoaded();
                    } catch(err) { showToast('PNG è§£æå¤±è´¥: ' + err.message, 'error'); }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function onFileLoaded() {
            var data = state.originalData.data || state.originalData;
            document.getElementById('cardPreview').classList.remove('hidden');
            var img = document.getElementById('previewImage');
            if(state.cardImageDataUrl) { img.src = state.cardImageDataUrl; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
            document.getElementById('cardName').textContent = data.name || 'æœªçŸ¥è§’è‰²';
            document.getElementById('cardCreator').textContent = data.creator ? 'by ' + data.creator : '';
            document.getElementById('cardSpec').textContent = (state.originalData.spec || 'V1') + ' v' + (state.originalData.spec_version || '1.0');
            updateConvertButtonState();
            showToast('å¯¼å…¥æˆåŠŸ', 'success');
        }

        function updateConvertButtonState() {
            var hasModel = document.getElementById('modelSelect').value;
            document.getElementById('convertBtn').disabled = !state.originalData || !hasModel;
        }

        document.getElementById('modelSelect').addEventListener('change', updateConvertButtonState);

        // ==================== å¹¶å‘ä»»åŠ¡ç®¡ç† (æ ¸å¿ƒé‡æ„) ====================
        
        function initConversion() {
            var apiUrl = document.getElementById('apiUrl').value.trim();
            var apiKey = document.getElementById('apiKey').value.trim();
            var modelName = document.getElementById('modelSelect').value;
            
            if (!apiUrl || !apiKey || !modelName) { showToast('è¯·å®Œå–„ API è®¾ç½®', 'error'); return; }
            
            // UI åˆå§‹åŒ–
            document.getElementById('convertBtn').classList.add('hidden');
            document.getElementById('controlPanel').classList.remove('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('diffSection').classList.add('hidden');
            document.getElementById('exportSection').classList.add('hidden');
            document.getElementById('retryBtn').classList.add('hidden');
            
            state.convertedData = JSON.parse(JSON.stringify(state.originalData));
            var data = state.convertedData.data || state.convertedData;
            
            // æ„å»ºä»»åŠ¡åˆ—è¡¨
            state.tasks = [];
            var fields = [
                { key: 'description', label: 'è§’è‰²æè¿°' },
                { key: 'first_mes', label: 'é¦–æ¡æ¶ˆæ¯' },
                { key: 'scenario', label: 'åœºæ™¯è®¾å®š' },
                { key: 'mes_example', label: 'å¯¹è¯ç¤ºä¾‹' },
                { key: 'personality', label: 'æ€§æ ¼ç‰¹å¾' },
                { key: 'system_prompt', label: 'ç³»ç»Ÿæç¤ºè¯' }
            ];
            
            // åŸºç¡€å­—æ®µ
            fields.forEach(function(f) {
                if (data[f.key] && data[f.key].trim()) {
                    state.tasks.push(createTask(f.key, f.label, data[f.key], function(res) { data[f.key] = res; }));
                }
            });
            
            // å¤‡ç”¨é—®å€™
            if (data.alternate_greetings) {
                data.alternate_greetings.forEach(function(text, i) {
                    if (text && text.trim()) {
                        state.tasks.push(createTask('alt_greeting_' + i, 'å¤‡ç”¨é—®å€™ ' + (i+1), text, function(res) { data.alternate_greetings[i] = res; }));
                    }
                });
            }
            
            // ä¸–ç•Œä¹¦
            if (data.character_book && data.character_book.entries) {
                data.character_book.entries.forEach(function(entry, i) {
                    if (entry.content && entry.content.trim()) {
                        state.tasks.push(createTask('book_' + i, 'ä¸–ç•Œä¹¦æ¡ç›® ' + (i+1), entry.content, function(res) { entry.content = res; }));
                    }
                });
            }
            
            state.totalCount = state.tasks.length;
            state.completedCount = 0;
            state.activeTasks = 0;
            state.isPaused = false;
            state.isProcessing = true;
            
            renderTaskList();
            processQueue(getChatUrl(apiUrl), apiKey, modelName);
        }

        function createTask(id, label, content, updateFn) {
            return {
                id: id,
                label: label,
                content: content,
                updateFn: updateFn,
                status: 'pending', // pending, processing, done, error
                errorMsg: ''
            };
        }

        function renderTaskList() {
            var container = document.getElementById('fieldProgress');
            container.innerHTML = '';
            state.tasks.forEach(function(task) {
                var div = document.createElement('div');
                div.className = 'field-item';
                div.id = 'task-el-' + task.id;
                div.innerHTML = 
                    '<div class="flex items-center overflow-hidden">' +
                        '<span class="status-indicator pending"></span>' +
                        '<span class="text-sm text-gray-300 truncate">' + task.label + '</span>' +
                    '</div>' +
                    '<span class="error-msg"></span>';
                container.appendChild(div);
            });
            updateProgressUI();
        }

        function updateTaskUI(task) {
            var el = document.getElementById('task-el-' + task.id);
            if (!el) return;
            var indicator = el.querySelector('.status-indicator');
            var errorSpan = el.querySelector('.error-msg');
            
            indicator.className = 'status-indicator ' + task.status;
            if (task.status === 'error') {
                errorSpan.textContent = task.errorMsg;
                errorSpan.title = task.errorMsg; // Tooltip
            } else {
                errorSpan.textContent = '';
            }
        }

        function updateProgressUI() {
            var pct = Math.round((state.completedCount / state.totalCount) * 100) || 0;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressCount').textContent = state.completedCount + '/' + state.totalCount;
            
            var statusText = state.isPaused ? 'å·²æš‚åœ' : (state.activeTasks > 0 ? 'æ­£åœ¨å¹¶å‘å¤„ç† ' + state.activeTasks + ' ä¸ªä»»åŠ¡...' : 'å¤„ç†å®Œæˆ');
            document.getElementById('progressStatus').textContent = statusText;
        }

        function togglePause() {
            state.isPaused = !state.isPaused;
            var btn = document.getElementById('pauseBtn');
            btn.textContent = state.isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
            btn.className = state.isPaused ? 'btn-primary py-3 text-lg font-semibold' : 'btn-secondary py-3 text-lg font-semibold';
            updateProgressUI();
            if (!state.isPaused) {
                var apiUrl = document.getElementById('apiUrl').value.trim();
                var apiKey = document.getElementById('apiKey').value.trim();
                var modelName = document.getElementById('modelSelect').value;
                processQueue(getChatUrl(apiUrl), apiKey, modelName);
            }
        }

        function retryFailed() {
            document.getElementById('retryBtn').classList.add('hidden');
            state.tasks.forEach(function(task) {
                if (task.status === 'error') {
                    task.status = 'pending';
                    task.errorMsg = '';
                    updateTaskUI(task);
                    state.completedCount--;
                }
            });
            state.isPaused = false;
            var apiUrl = document.getElementById('apiUrl').value.trim();
            var apiKey = document.getElementById('apiKey').value.trim();
            var modelName = document.getElementById('modelSelect').value;
            processQueue(getChatUrl(apiUrl), apiKey, modelName);
        }

        function processQueue(apiUrl, apiKey, modelName) {
            if (state.isPaused) return;

            // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
            if (state.completedCount === state.totalCount) {
                onAllFinished();
                return;
            }

            // å¡«å……å¹¶å‘æ± 
            while (state.activeTasks < state.maxConcurrency && !state.isPaused) {
                var task = state.tasks.find(function(t) { return t.status === 'pending'; });
                if (!task) break; // æ²¡æœ‰å¾…å¤„ç†ä»»åŠ¡

                runTask(task, apiUrl, apiKey, modelName);
            }
        }

        function runTask(task, apiUrl, apiKey, modelName) {
            state.activeTasks++;
            task.status = 'processing';
            updateTaskUI(task);
            updateProgressUI();

            convertTextWithAI(task.content, apiUrl, apiKey, modelName)
                .then(function(result) {
                    task.updateFn(result);
                    task.status = 'done';
                })
                .catch(function(err) {
                    task.status = 'error';
                    // æå–æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    var msg = err.message;
                    if (msg.indexOf('429') !== -1) msg = '429 è¯·æ±‚è¿‡å¤š';
                    else if (msg.indexOf('404') !== -1) msg = '404 æ¥å£é”™è¯¯';
                    else if (msg.indexOf('500') !== -1) msg = '500 æœåŠ¡å™¨é”™';
                    else if (msg.indexOf('Failed to fetch') !== -1) msg = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                    task.errorMsg = msg;
                })
                .finally(function() {
                    state.activeTasks--;
                    state.completedCount++;
                    updateTaskUI(task);
                    updateProgressUI();
                    processQueue(apiUrl, apiKey, modelName); // è§¦å‘ä¸‹ä¸€ä¸ª
                });
        }

        function onAllFinished() {
            var hasError = state.tasks.some(function(t) { return t.status === 'error'; });
            if (hasError) {
                document.getElementById('retryBtn').classList.remove('hidden');
                showToast('éƒ¨åˆ†ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¹¶é‡è¯•', 'error');
            } else {
                showDiffPreview();
                document.getElementById('exportSection').classList.remove('hidden');
                document.getElementById('controlPanel').classList.add('hidden');
                document.getElementById('convertBtn').textContent = 'âœ… è½¬æ¢æˆåŠŸ (ç‚¹å‡»é‡æ–°å¼€å§‹)';
                document.getElementById('convertBtn').classList.remove('hidden');
                document.getElementById('convertBtn').disabled = false;
                document.getElementById('convertBtn').onclick = function() { location.reload(); };
                showToast('æ‰€æœ‰ä»»åŠ¡è½¬æ¢å®Œæˆï¼', 'success');
            }
        }

        // ==================== AI è¯·æ±‚ ====================
        function convertTextWithAI(text, apiUrl, apiKey, modelName) {
            var genderTarget = state.targetGender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
            var systemPrompt = 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ–‡æœ¬ç¼–è¾‘ä¸“å®¶ã€‚ä»»åŠ¡ï¼šå°†æ–‡æœ¬ä¸­å…³äº"ç”¨æˆ·/ç©å®¶/You/{{user}}"çš„æ€§åˆ«æè¿°è½¬æ¢ä¸º' + genderTarget + 'ã€‚\nåŸåˆ™ï¼š\n1. ä»…ä¿®æ”¹Useræ€§åˆ«ç›¸å…³è¯(ä»–/å¥¹, å“¥å“¥/å§å§, èº«ä½“éƒ¨ä½ç­‰)ã€‚\n2. 100%ä¿ç•™åŸæ ¼å¼ã€ç¬¦å·ã€æ–‡é£ã€‚\n3. è¯†åˆ«BG/BL/GLé€»è¾‘ï¼Œå¤„ç†è§£å‰–å­¦æœ¯è¯­ã€‚\n4. ç›´æ¥è¾“å‡ºä¿®æ”¹åæ–‡æœ¬ï¼Œæ— è§£é‡Šã€‚';

            return fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                body: JSON.stringify({
                    model: modelName,
                    messages: [ { role: 'system', content: systemPrompt }, { role: 'user', content: text } ],
                    temperature: 0.3, max_tokens: 8192
                })
            }).then(function(res) {
                if (!res.ok) {
                    // å°è¯•è¯»å–é”™è¯¯è¯¦æƒ…
                    return res.text().then(function(text) {
                        try {
                            var json = JSON.parse(text);
                            var msg = (json.error && json.error.message) || text;
                            throw new Error(res.status + ' ' + msg);
                        } catch(e) {
                            throw new Error(res.status + ' ' + res.statusText);
                        }
                    });
                }
                return res.json();
            }).then(function(json) {
                return json.choices[0].message.content;
            });
        }

        // ==================== Diff & Export (ä¿æŒä¸å˜) ====================
        function showDiffPreview() {
            document.getElementById('diffSection').classList.remove('hidden');
            var diffContent = document.getElementById('diffContent');
            diffContent.innerHTML = '';
            
            // ç®€å•å¤ç”¨ tasks æ¥ç”Ÿæˆ diffï¼Œå› ä¸º tasks åŒ…å«äº†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å­—æ®µ
            var html = '';
            state.tasks.forEach(function(task) {
                if (task.status !== 'done') return;
                // åªæœ‰å†…å®¹å˜äº†æ‰æ˜¾ç¤º
                var newVal = '';
                task.updateFn({ toString: function() { return newVal; } }); // Hacky way to get new value if we didn't store it separately? 
                // å…¶å® task.updateFn å·²ç»ä¿®æ”¹äº† convertedDataï¼Œæˆ‘ä»¬ç›´æ¥å¯¹æ¯” originalData å’Œ convertedData å¯¹åº”ä½ç½®æ›´ç¨³å¦¥
                // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬é‡æ–°éå†å­—æ®µç”Ÿæˆ diffï¼Œé€»è¾‘åŒä¹‹å‰
            });
            
            // ä½¿ç”¨ä¹‹å‰çš„é€»è¾‘é‡æ–°ç”Ÿæˆ diff
            var orig = state.originalData.data || state.originalData;
            var conv = state.convertedData.data || state.convertedData;
            
            // ... (Diff ç”Ÿæˆé€»è¾‘ä¸ä¹‹å‰ç›¸åŒï¼Œç•¥å¾®ç®€åŒ–) ...
            // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¹‹å‰çš„ generateDiff é€»è¾‘
            var fields = [
                { key: 'description', label: 'è§’è‰²æè¿°' },
                { key: 'first_mes', label: 'é¦–æ¡æ¶ˆæ¯' },
                { key: 'scenario', label: 'åœºæ™¯è®¾å®š' },
                { key: 'mes_example', label: 'å¯¹è¯ç¤ºä¾‹' },
                { key: 'personality', label: 'æ€§æ ¼ç‰¹å¾' },
                { key: 'system_prompt', label: 'ç³»ç»Ÿæç¤ºè¯' }
            ];
            if (orig.alternate_greetings) orig.alternate_greetings.forEach((_, i) => fields.push({key: 'alt', idx: i, label: 'å¤‡ç”¨é—®å€™ '+(i+1)}));
            if (orig.character_book && orig.character_book.entries) orig.character_book.entries.forEach((_, i) => fields.push({key: 'book', idx: i, label: 'ä¸–ç•Œä¹¦ '+(i+1)}));

            fields.forEach(function(f) {
                var oTxt = '', cTxt = '';
                if(f.key === 'alt') { oTxt = orig.alternate_greetings[f.idx]; cTxt = conv.alternate_greetings[f.idx]; }
                else if(f.key === 'book') { oTxt = orig.character_book.entries[f.idx].content; cTxt = conv.character_book.entries[f.idx].content; }
                else { oTxt = orig[f.key]; cTxt = conv[f.key]; }
                
                if(oTxt && cTxt && oTxt !== cTxt) {
                    html += '<div class="field-item block"><div class="collapsible-header" onclick="this.nextElementSibling.classList.toggle(\'open\')"><h3 class="font-medium text-purple-300">'+f.label+'</h3><span class="text-xs text-gray-500">ç‚¹å‡»å±•å¼€</span></div><div class="collapsible-content open"><div class="preview-section mt-2 text-sm text-gray-300 whitespace-pre-wrap">'+generateDiff(oTxt, cTxt)+'</div></div></div>';
                }
            });
            diffContent.innerHTML = html || '<p class="text-gray-500 text-center">æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜æ›´</p>';
        }

        function generateDiff(oldText, newText) {
            var oldWords = oldText.split(/(\s+)/), newWords = newText.split(/(\s+)/);
            var result = '', i = 0, j = 0;
            while (i < oldWords.length || j < newWords.length) {
                if (i >= oldWords.length) { result += '<span class="diff-added">'+escapeHtml(newWords[j++])+'</span>'; }
                else if (j >= newWords.length) { result += '<span class="diff-removed">'+escapeHtml(oldWords[i++])+'</span>'; }
                else if (oldWords[i] === newWords[j]) { result += escapeHtml(oldWords[i++]); j++; }
                else {
                    var nIdx = newWords.indexOf(oldWords[i], j), oIdx = oldWords.indexOf(newWords[j], i);
                    if (nIdx !== -1 && (oIdx === -1 || nIdx - j < oIdx - i)) { while (j < nIdx) result += '<span class="diff-added">'+escapeHtml(newWords[j++])+'</span>'; }
                    else if (oIdx !== -1) { while (i < oIdx) result += '<span class="diff-removed">'+escapeHtml(oldWords[i++])+'</span>'; }
                    else { result += '<span class="diff-removed">'+escapeHtml(oldWords[i++])+'</span><span class="diff-added">'+escapeHtml(newWords[j++])+'</span>'; }
                }
            }
            return result;
        }
        function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        // ==================== PNG å¤„ç† (ä¿æŒä¸å˜) ====================
        function safeUint8ArrayToString(u8a) {
            if (typeof TextDecoder !== 'undefined') return new TextDecoder('iso-8859-1').decode(u8a);
            var res = [], chunk = 0x8000;
            for (var i=0; i<u8a.length; i+=chunk) res.push(String.fromCharCode.apply(null, u8a.subarray(i, i+chunk)));
            return res.join('');
        }
        function extractCharaFromPNG(buf) {
            var view = new DataView(buf.buffer), off = 8;
            while (off < buf.length) {
                var len = view.getUint32(off), type = String.fromCharCode.apply(null, buf.slice(off+4, off+8));
                if (type === 'tEXt' || type === 'iTXt') {
                    var data = buf.slice(off+8, off+8+len), nullIdx = data.indexOf(0);
                    var key = String.fromCharCode.apply(null, data.slice(0, nullIdx));
                    if (key === 'chara') {
                        if (type === 'tEXt') return safeUint8ArrayToString(data.slice(nullIdx+1));
                        var p = nullIdx+3; while(data[p]) p++; p++; while(data[p]) p++; p++;
                        return new TextDecoder('utf-8').decode(data.slice(p));
                    }
                }
                if (type === 'IEND') break; off += 12+len;
            }
            return null;
        }
        function replaceCharaInPNG(buf, b64) {
            var chunks = [], view = new DataView(buf.buffer), off = 8, inserted = false;
            chunks.push(buf.slice(0, 8));
            while (off < buf.length) {
                var len = view.getUint32(off), type = String.fromCharCode.apply(null, buf.slice(off+4, off+8));
                if ((type === 'tEXt' || type === 'iTXt') && !inserted) {
                    var data = buf.slice(off+8, off+8+len), nullIdx = data.indexOf(0);
                    if (String.fromCharCode.apply(null, data.slice(0, nullIdx)) === 'chara') {
                        chunks.push(createChunk('tEXt', 'chara', b64)); inserted = true; off += 12+len; continue;
                    }
                }
                if (type === 'IDAT' && !inserted) { chunks.push(createChunk('tEXt', 'chara', b64)); inserted = true; }
                chunks.push(buf.slice(off, off+12+len)); if (type === 'IEND') break; off += 12+len;
            }
            var total = chunks.reduce((s, c) => s+c.length, 0), res = new Uint8Array(total), p = 0;
            chunks.forEach(c => { res.set(c, p); p += c.length; });
            return res;
        }
        function createChunk(type, key, val) {
            var k = new TextEncoder().encode(key), v = new TextEncoder().encode(val);
            var len = k.length + 1 + v.length, buf = new Uint8Array(12 + len), view = new DataView(buf.buffer);
            view.setUint32(0, len); buf.set(new TextEncoder().encode(type), 4);
            buf.set(k, 8); buf[8+k.length] = 0; buf.set(v, 9+k.length);
            var crc = 0xFFFFFFFF, table = new Uint32Array(256);
            for(var i=0; i<256; i++) { var c=i; for(var j=0; j<8; j++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); table[i]=c; }
            for(var i=4; i<8+len; i++) crc = (crc>>>8)^table[(crc^buf[i])&0xFF];
            view.setUint32(8+len, (crc^0xFFFFFFFF)>>>0);
            return buf;
        }

        function exportJSON() {
            var name = state.originalFileName + '_' + (state.targetGender==='male'?'Male':'Female') + '_User.json';
            download(new Blob([JSON.stringify(state.convertedData, null, 2)], {type:'application/json'}), name);
        }
        function exportPNG() {
            if (!state.originalPngBuffer) return showToast('åŸå§‹PNGæ— æ•ˆ', 'error');
            var b64 = btoa(unescape(encodeURIComponent(JSON.stringify(state.convertedData))));
            var name = state.originalFileName + '_' + (state.targetGender==='male'?'Male':'Female') + '_User.png';
            download(new Blob([replaceCharaInPNG(state.originalPngBuffer, b64)], {type:'image/png'}), name);
        }
        function download(blob, name) {
            var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>
