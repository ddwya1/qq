<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è§’è‰²å¡é‡æ„å° (JSONç»“æ„é”)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¡€è®¾ç½® */
        body { background-color: #09090b; color: #e4e4e7; font-family: sans-serif; padding-bottom: 40px; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            position: sticky; top: 0; z-index: 50;
            background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid #27272a;
            padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav-title { font-weight: 800; font-size: 1.1rem; color: #a78bfa; } 
        
        /* è®¾ç½®é¢æ¿ */
        #settingsPanel { background: #18181b; border-bottom: 1px solid #27272a; padding: 16px; display: none; }

        /* è¾“å…¥æ¡†ä¸æŒ‰é’® */
        .input-dark {
            background: #27272a; border: 1px solid #3f3f46; color: white;
            padding: 10px; border-radius: 8px; width: 100%; font-size: 14px; margin-bottom: 8px;
        }
        .btn {
            display: flex; justify-content: center; align-items: center;
            padding: 10px; border-radius: 8px; font-weight: 600; font-size: 14px;
            border: none; width: 100%; margin-bottom: 5px; cursor: pointer;
        }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: #2563eb; color: white; }
        .btn-red { background: #dc2626; color: white; }
        .btn-gray { background: #3f3f46; color: white; }
        .btn-stop { background: #ef4444; color: white; padding: 4px 12px; font-size: 12px; border-radius: 20px; margin-left: 10px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: #18181b; border: 1px solid #27272a; border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
        .card-header { background: #27272a; padding: 10px 14px; font-size: 13px; font-weight: bold; color: #a1a1aa; display: flex; justify-content: space-between; }
        
        /* æ–‡æœ¬å†…å®¹æ ·å¼ */
        .text-content {
            background: #09090b; color: #d4d4d8; padding: 14px; 
            font-family: monospace; font-size: 13px; line-height: 1.8; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            border-top: 1px solid #27272a;
        }
        
        /* çŠ¶æ€åŠ¨ç”» */
        .highlight-change { animation: flash 1.5s; }
        @keyframes flash { 0% { background: rgba(16, 185, 129, 0.2); } 100% { background: #09090b; } }
        .upload-box { border: 2px dashed #3f3f46; border-radius: 12px; padding: 40px 20px; text-align: center; color: #71717a; margin: 16px; cursor: pointer; }
    </style>
    <script>
        window.onerror = function(msg, url, line) {
            alert("é”™è¯¯:\n" + msg + "\nè¡Œ: " + line);
            return false;
        };
    </script>
</head>
<body>

    <div class="navbar">
        <div class="nav-title">ğŸ§¬ è§’è‰²é‡æ„å° (JSONé”)</div>
        <button onclick="toggleSettings()" style="font-size:20px; background:none; border:none; cursor:pointer;">âš™ï¸</button>
    </div>

    <div id="settingsPanel">
        <input type="text" id="apiUrl" class="input-dark" placeholder="API URL (ä¾‹å¦‚ https://api.openai.com/v1)">
        <input type="password" id="apiKey" class="input-dark" placeholder="API Key">
        <div class="flex gap-2">
            <button onclick="loadModels()" id="loadBtn" class="btn btn-blue">è¿æ¥æœåŠ¡å™¨</button>
            <select id="modelSelect" class="input-dark" disabled><option>è¯·å…ˆè¿æ¥</option></select>
        </div>
    </div>

    <div class="p-4 flex flex-col gap-3">
        <div class="bg-[#18181b] p-3 rounded-xl border border-[#27272a]">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-blue-400">AI æ™ºèƒ½æ”¹å†™</span>
                <div id="aiStatus" class="hidden flex items-center">
                    <span id="statusText" class="text-xs text-yellow-500">å¤„ç†ä¸­...</span>
                    <button onclick="stopAiConvert()" class="btn-stop">â¹ï¸ åœæ­¢</button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="startAiConvert('male')" class="btn btn-blue">â™‚ è½¬ç”· (BL/BG)</button>
                <button onclick="startAiConvert('female')" class="btn btn-red">â™€ è½¬å¥³ (BG/GL)</button>
            </div>
            <div class="text-[10px] text-gray-600 mt-1 text-center">å·²å¯ç”¨ JSON ç»“æ„é”ï¼Œé˜²æ­¢æ ¼å¼é”™ä¹±</div>
        </div>

        <div class="bg-[#18181b] p-3 rounded-xl border border-[#27272a]">
            <div class="text-xs font-bold text-gray-500 mb-2">æ‰‹åŠ¨æ›¿æ¢</div>
            <div class="flex gap-2">
                <input type="text" id="findText" class="input-dark" placeholder="æŸ¥æ‰¾">
                <input type="text" id="replaceText" class="input-dark" placeholder="æ›¿æ¢">
            </div>
            <button onclick="applyManualReplace()" class="btn btn-gray">æ‰§è¡Œæ›¿æ¢</button>
        </div>
    </div>

    <div id="dropZone" class="upload-box" onclick="document.getElementById('fileInput').click()">
        <input type="file" id="fileInput" class="hidden" accept=".png,.json" onchange="handleFile(this.files[0])">
        <div class="text-4xl mb-2">ğŸ“‚</div>
        <div class="text-sm">ç‚¹å‡»ä¸Šä¼ è§’è‰²å¡ (JSON/PNG)</div>
    </div>

    <div id="contentArea" class="hidden px-4 pb-10">
        <div class="text-xs font-bold text-gray-500 mb-2 mt-4 uppercase">åŸºç¡€ä¿¡æ¯</div>
        <div id="charContainer"></div>
        <div class="flex justify-between items-end mb-2 mt-6">
            <div class="text-xs font-bold text-gray-500 uppercase">ä¸–ç•Œä¹¦</div>
            <div id="worldCount" class="text-xs text-gray-600"></div>
        </div>
        <div id="worldContainer"></div>
    </div>

    <script>
        // --- è®¾ç½®ä¸è¿æ¥ ---
        function toggleSettings() {
            var panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        async function loadModels() {
            var rawUrl = document.getElementById('apiUrl').value.trim();
            if (!rawUrl) return alert('è¯·å…ˆå¡«å†™ API URL');
            
            var baseUrl = rawUrl.replace(/\/\(/, '').replace(/\/chat\/completions\)/, '');
            var key = document.getElementById('apiKey').value.trim();
            var btn = document.getElementById('loadBtn');
            var sel = document.getElementById('modelSelect');

            btn.disabled = true; btn.innerText = 'è¿æ¥ä¸­...';
            
            try {
                var res = await fetch(baseUrl + '/models', { 
                    method: 'GET', headers: { 'Authorization': 'Bearer ' + key } 
                });

                if (!res.ok) throw new Error('HTTP ' + res.status);
                var data = await res.json();
                var list = Array.isArray(data) ? data : (data.data || []);
                
                sel.innerHTML = '';
                if (list.length === 0) throw new Error('åˆ—è¡¨ä¸ºç©º');

                list.sort(function(a,b) {
                    var idA = (a.id||a).toLowerCase();
                    return idA.indexOf('gpt') !== -1 ? -1 : 1;
                });

                list.forEach(function(m) {
                    var id = m.id || m;
                    var opt = document.createElement('option');
                    opt.value = id; opt.innerText = id;
                    sel.appendChild(opt);
                });
                
                sel.disabled = false;
                alert('è¿æ¥æˆåŠŸ');
                toggleSettings(); // æˆåŠŸåè‡ªåŠ¨æ”¶èµ·
            } catch(e) {
                alert('è¿æ¥å¤±è´¥: ' + e.message);
            } finally {
                btn.disabled = false; btn.innerText = 'è¿æ¥æœåŠ¡å™¨';
            }
        }

        // --- AI å¤„ç†æ ¸å¿ƒé€»è¾‘ (JSONé”æ­»ç‰ˆ) ---
        var isProcessing = false;
        var shouldStop = false;

        function stopAiConvert() {
            if (isProcessing) {
                shouldStop = true;
                document.getElementById('statusText').innerText = "æ­£åœ¨åœæ­¢...";
            }
        }

        async function startAiConvert(gender) {
            if (isProcessing) return;
            var blocks = document.querySelectorAll('.text-content');
            if (blocks.length === 0) return alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');

            var model = document.getElementById('modelSelect').value;
            if (document.getElementById('modelSelect').disabled || !model) return alert('è¯·å…ˆè¿æ¥API');

            var confirmMsg = gender === 'male' ? 'è½¬ä¸ºç”·æ€§ (BL/BG)' : 'è½¬ä¸ºå¥³æ€§ (BG/GL)';
            if (!confirm('ç¡®è®¤' + confirmMsg + 'ï¼Ÿ\n(å·²å¯ç”¨JSONå¼ºåŠ›ç»“æ„é”ï¼Œå¤„ç†é€Ÿåº¦å¯èƒ½ç¨æ…¢)')) return;

            isProcessing = true;
            shouldStop = false;
            document.getElementById('aiStatus').classList.remove('hidden');
            
            var target = gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
            var avoid = gender === 'male' ? 'å¥¹' : 'ä»–';
            var want = gender === 'male' ? 'ä»–' : 'å¥¹';

            // Prompt: å¼ºåˆ¶ AI ä½œä¸ºæ•°æ®å¤„ç†å™¨ï¼Œè€Œéå°è¯´å®¶
            var prompt = 
                "ä½ æ˜¯ä¸€ä¸ª JSON æ•°æ®å¤„ç†å™¨ã€‚ä»»åŠ¡æ˜¯å°†è¾“å…¥çš„å­—ç¬¦ä¸²æ•°ç»„è¿›è¡Œå˜é‡æ›¿æ¢ã€‚\n" +
                "ã€æ›¿æ¢è§„åˆ™ã€‘ï¼š\n" +
                "1. Useræ€§åˆ«é€»è¾‘è½¬ä¸ºã€" + target + "ã€‘ã€‚\n" +
                "2. å°†ä»£è¯ã€" + avoid + "ã€‘æ›¿æ¢ä¸ºã€" + want + "ã€‘ã€‚\n" +
                "3. ä¿®æ”¹ç”Ÿç†/NSFWæè¿°ä»¥åŒ¹é…" + target + "ã€‚\n" +
                "ã€ä¸¥æ ¼æ ¼å¼è¦æ±‚ã€‘ï¼š\n" +
                "1. æ¥æ”¶ JSON æ•°ç»„ï¼Œå¿…é¡»è¿”å› JSON æ•°ç»„ã€‚\n" +
                "2. ä¸¥ç¦åˆå¹¶æ•°ç»„å…ƒç´ ï¼è¾“å…¥æœ‰å¤šå°‘è¡Œï¼Œè¾“å‡ºå°±å¿…é¡»æœ‰å¤šå°‘è¡Œã€‚\n" +
                "3. ä¸¥ç¦ä¿®æ”¹ < > æ ‡ç­¾å’Œ {{user}} å ä½ç¬¦ã€‚\n" +
                "4. ä¿æŒç©ºå­—ç¬¦ä¸²å…ƒç´ ä¸å˜ï¼Œä»¥ç»´æŒæ®µè½é—´è·ã€‚\n" +
                "5. ä»…è¾“å‡º JSONï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚";

            var count = 0;
            for (var i = 0; i < blocks.length; i++) {
                if (shouldStop) { alert('å·²åœæ­¢'); break; }

                var block = blocks[i];
                var txt = block.textContent;
                // å¦‚æœå†…å®¹å¤ªçŸ­ï¼Œæ²¡å¿…è¦ç”¨ JSON é”ï¼Œç›´æ¥å¤„ç†ï¼ˆçœtokenï¼‰ï¼Œä½†ä¸ºäº†ç¨³å¦¥è¿™é‡Œç»Ÿä¸€ç”¨ JSON
                if (!txt || !txt.trim()) continue;

                count++;
                document.getElementById('statusText').innerText = "å¤„ç†ä¸­ " + count + "/" + blocks.length;
                block.parentElement.style.opacity = '0.5';

                // 1. åˆ‡å‰²æ–‡æœ¬ä¸ºæ•°ç»„ (ä¿ç•™ç©ºè¡Œï¼Œç©ºè¡Œæ˜¯æ®µè½é—´è·çš„å…³é”®)
                var lines = txt.split(/\r\n|\n/);
                
                // 2. åŒ…è£…ä¸º JSON
                var jsonPayload = JSON.stringify(lines);

                try {
                    // 3. å‘é€ç»™ AI
                    var responseText = await callAi(jsonPayload, prompt, model);
                    
                    if (shouldStop) { block.parentElement.style.opacity = '1'; alert('å·²åœæ­¢'); break; }

                    if (responseText) {
                        // 4. è§£æ AI è¿”å›çš„ JSON
                        var resultLines = null;
                        try {
                            // æ¸…æ´—å¯èƒ½å­˜åœ¨çš„ Markdown æ ‡è®°
                            var cleanJson = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                            // æˆªå–åˆæ³•çš„ JSON éƒ¨åˆ†
                            var start = cleanJson.indexOf('[');
                            var end = cleanJson.lastIndexOf(']');
                            if (start !== -1 && end !== -1) {
                                cleanJson = cleanJson.substring(start, end + 1);
                                resultLines = JSON.parse(cleanJson);
                            } else {
                                // å¦‚æœ AI æ²¡è¿”å› JSONï¼ˆæå°‘æƒ…å†µï¼‰ï¼Œå°è¯•ç›´æ¥ç”¨æ–‡æœ¬
                                console.warn("AIæœªè¿”å›JSONï¼Œé™çº§å¤„ç†");
                            }
                        } catch (e) {
                            console.error("JSONè§£æå¤±è´¥", e);
                        }

                        // 5. è¿˜åŸæ–‡æœ¬
                        if (Array.isArray(resultLines)) {
                            // æ•°ç»„é‡æ–°æ‹¼å›æ–‡æœ¬ï¼Œä½¿ç”¨æ¢è¡Œç¬¦è¿æ¥
                            var newTxt = resultLines.join("\n");
                            
                            // å…œåº•ä¿®å¤ï¼šé˜²æ­¢ XML æ ‡ç­¾è¢«æ„å¤–ç²˜è¿
                            newTxt = newTxt.replace(/>\s*</g, ">\n<");

                            if (newTxt !== txt) {
                                block.textContent = newTxt;
                                block.classList.add('highlight-change');
                                (function(el) {
                                    setTimeout(function() { el.classList.remove('highlight-change'); }, 1500);
                                })(block);
                            }
                        } else {
                            // å¦‚æœè§£æå¤±è´¥ï¼Œè¯´æ˜ AI è¿˜æ˜¯è¾“å‡ºäº†çº¯æ–‡æœ¬ï¼Œç›´æ¥ç”¨çº¯æ–‡æœ¬ï¼ˆè™½ç„¶å¯èƒ½æ ¼å¼ä¹±äº†ï¼Œä½†æ¯”æŠ¥é”™å¥½ï¼‰
                            // é€šå¸¸ç”¨äº† JSON Prompt åä¸ä¼šè¿›è¿™é‡Œ
                            if (responseText.length > 0 && responseText.indexOf('[') === -1) {
                                block.textContent = responseText; 
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    block.style.border = "1px solid red";
                }
                block.parentElement.style.opacity = '1';
            }

            isProcessing = false;
            document.getElementById('aiStatus').classList.add('hidden');
            if (!shouldStop) alert('å¤„ç†å®Œæˆ');
            shouldStop = false;
        }

        async function callAi(text, sys, model) {
            var rawUrl = document.getElementById('apiUrl').value.trim();
            var baseUrl = rawUrl.replace(/\/\(/, '').replace(/\/chat\/completions\)/, '');
            var url = baseUrl + '/chat/completions';
            var key = document.getElementById('apiKey').value;

            var res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
                body: JSON.stringify({
                    model: model,
                    messages: [{role:'system',content:sys},{role:'user',content:text}],
                    temperature: 0.1, // ä½æ¸©ä¿è¯é€»è¾‘ä¸¥å¯†ï¼Œä¸ä¹±æ”¹æ ¼å¼
                    max_tokens: 4000
                })
            });

            if (!res.ok) {
                var errTxt = await res.text();
                throw new Error('API Error: ' + res.status);
            }

            var json = await res.json();
            if (json.choices && json.choices.length > 0) {
                return json.choices[0].message.content;
            }
            return text;
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function applyManualReplace() {
            var f = document.getElementById('findText').value;
            var r = document.getElementById('replaceText').value;
            if (!f) return alert('è¯·è¾“å…¥æŸ¥æ‰¾å†…å®¹');
            
            var blocks = document.querySelectorAll('.text-content');
            var n = 0;
            
            for (var i = 0; i < blocks.length; i++) {
                var el = blocks[i];
                if (el.textContent.indexOf(f) !== -1) {
                    el.textContent = el.textContent.split(f).join(r);
                    el.classList.add('highlight-change');
                    (function(elem) {
                        setTimeout(function() { elem.classList.remove('highlight-change'); }, 1500);
                    })(el);
                    n++;
                }
            }
            alert('å·²æ›¿æ¢ ' + n + ' å¤„');
        }

        function handleFile(file) {
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                var d = e.target.result;
                if (file.name.toLowerCase().indexOf('.png') !== -1) {
                    var txt = extractPng(new Uint8Array(d));
                    if (!txt) return alert('æ— æ•ˆ PNG');
                    parseData(txt);
                } else {
                    parseData(d);
                }
            };
            if (file.name.toLowerCase().indexOf('.png') !== -1) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function parseData(str) {
            try {
                var d;
                try { d = JSON.parse(str); } 
                catch (e) { 
                    var b = atob(str); 
                    var arr = new Uint8Array(b.length);
                    for(var i=0; i<b.length; i++) arr[i] = b.charCodeAt(i);
                    d = JSON.parse(new TextDecoder('utf-8').decode(arr));
                }
                
                var data = d.data || d;
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('contentArea').classList.remove('hidden');
                
                var cBox = document.getElementById('charContainer'); cBox.innerHTML = '';
                var wBox = document.getElementById('worldContainer'); wBox.innerHTML = '';

                var map = [['description','æè¿°'], ['first_mes','å¼€åœºç™½'], ['personality','æ€§æ ¼'], ['scenario','åœºæ™¯'], ['mes_example','ç¤ºä¾‹'], ['system_prompt','ç³»ç»Ÿæç¤º'], ['post_history_instructions','åæŒ‡ä»¤']];
                
                map.forEach(function(item) {
                    var k = item[0]; var l = item[1];
                    if (data[k]) addCard(cBox, l, data[k]);
                });

                if (data.alternate_greetings) {
                    data.alternate_greetings.forEach(function(v,i) { addCard(cBox, 'å¤‡ç”¨ #'+(i+1), v); });
                }
                if (data.group_only_greetings) {
                    data.group_only_greetings.forEach(function(v,i) { addCard(cBox, 'ç¾¤èŠ #'+(i+1), v); });
                }

                var books = [];
                if (data.character_book && data.character_book.entries) books = data.character_book.entries;
                else if (d.character_book && d.character_book.entries) books = d.character_book.entries;

                document.getElementById('worldCount').innerText = books.length + ' æ¡ç›®';
                
                books.forEach(function(e,i) {
                    if (!e.content) return;
                    var t = e.comment || (e.keys ? 'Keys: '+e.keys.join(', ') : '#'+(i+1));
                    addCard(wBox, t, e.content);
                });

            } catch(e) { console.error(e); alert('è§£æå¤±è´¥: ' + e.message); }
        }

        function addCard(box, title, text) {
            var div = document.createElement('div'); div.className = 'card';
            
            var header = document.createElement('div'); header.className = 'card-header';
            var span = document.createElement('span'); span.innerText = title;
            var btn = document.createElement('button'); 
            btn.className = 'btn btn-blue'; 
            btn.style.width = 'auto'; btn.style.padding = '4px 8px'; btn.style.fontSize = '12px'; btn.style.marginBottom = '0';
            btn.innerText = 'å¤åˆ¶';
            btn.onclick = function() { copy(this); };

            header.appendChild(span); header.appendChild(btn);

            var body = document.createElement('div'); body.className = 'card-body';
            var txtDiv = document.createElement('div'); txtDiv.className = 'text-content';
            txtDiv.innerText = text;

            body.appendChild(txtDiv);
            div.appendChild(header); div.appendChild(body);
            box.appendChild(div);
        }

        function copy(btn) {
            var txt = btn.parentElement.nextElementSibling.innerText;
            navigator.clipboard.writeText(txt).then(function() {
                var old = btn.innerText; btn.innerText = 'OK';
                setTimeout(function(){ btn.innerText=old; }, 1000);
            });
        }

        function extractPng(buf) {
            var view = new DataView(buf.buffer); var p=8; var dec = new TextDecoder('utf-8');
            while(p < buf.length) {
                var len = view.getUint32(p); 
                var type = dec.decode(buf.slice(p+4, p+8));
                if(type === 'tEXt' || type === 'iTXt') {
                    var d = buf.slice(p+8, p+8+len); 
                    var split = d.indexOf(0);
                    if(dec.decode(d.slice(0, split)) === 'chara') {
                        if (type === 'tEXt') return dec.decode(d.slice(split+1));
                        else {
                            var p2 = split + 3;
                            while (p2 < d.length && d[p2] !== 0) p2++; p2++;
                            while (p2 < d.length && d[p2] !== 0) p2++; p2++;
                            return dec.decode(d.slice(p2));
                        }
                    }
                }
                p += 12+len;
            }
            return null;
        }
    </script>
</body>
</html>
