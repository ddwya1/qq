<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SillyTavern è§’è‰²å¡æ€§åˆ«è½¬æ¢ (å…¨åŸŸæ‰«æç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        :root { --glass-bg: rgba(10, 10, 15, 0.98); --glass-border: rgba(255, 255, 255, 0.08); --accent: #3b82f6; }
        body { background: #020202; color: #e4e4e7; min-height: 100vh; font-family: sans-serif; }
        .glass { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; }
        .glass-input, .glass-select { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; transition: 0.2s; }
        .glass-input:focus { border-color: var(--accent); outline: none; }
        .btn-primary { background: var(--accent); color: white; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.2); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.2s; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; z-index: 9999; animation: slideIn 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .toast.success { background: #10b981; } .toast.error { background: #ef4444; } .toast.info { background: #3b82f6; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-dot.pending { background: #52525b; } .status-dot.processing { background: #3b82f6; animation: pulse 1s infinite; }
        .status-dot.done { background: #10b981; } .status-dot.error { background: #ef4444; }
        @keyframes pulse { 50% { opacity: 0.5; } }
        .hidden { display: none; }
        .tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); color: #aaa; margin-left: 6px; }
    </style>
</head>
<body class="p-4 pb-20 max-w-2xl mx-auto">
    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-blue-400">ğŸ” å…¨åŸŸè§’è‰²å¡é‡æ„å·¥å…·</h1>
        <p class="text-xs text-gray-500 mt-1">æ·±åº¦é€’å½’æ‰«æ Â· ä¸–ç•Œä¹¦æ— æ­»è§’è¦†ç›–</p>
    </div>

    <!-- API è®¾ç½® -->
    <div class="glass p-4 mb-4">
        <h2 class="font-bold mb-3 text-sm text-gray-300">âš™ï¸ API è¿æ¥</h2>
        <div class="space-y-3">
            <input type="text" id="apiUrl" class="glass-input w-full p-2 text-sm" placeholder="API URL (ä¾‹å¦‚ https://api.openai.com/v1)" onchange="clearModelList()">
            <input type="password" id="apiKey" class="glass-input w-full p-2 text-sm" placeholder="API Key (sk-...)" onchange="clearModelList()">
            <div class="flex gap-2">
                <select id="modelSelect" class="glass-select flex-1 p-2 text-sm" disabled><option>è¯·å…ˆåŠ è½½æ¨¡å‹</option></select>
                <button onclick="loadModels()" id="loadBtn" class="glass-input px-4 text-sm hover:bg-white/5">ğŸ”„ åŠ è½½</button>
            </div>
        </div>
    </div>

    <!-- ç›®æ ‡æ€§åˆ« -->
    <div class="glass p-4 mb-4">
        <div class="flex gap-2">
            <button id="btn-male" class="flex-1 p-3 rounded-lg border border-transparent bg-white/5 text-gray-400 transition" onclick="setGender('male')">è½¬ä¸ºç”·æ€§ User â™‚ï¸</button>
            <button id="btn-female" class="flex-1 p-3 rounded-lg border border-transparent bg-white/5 text-gray-400 transition" onclick="setGender('female')">è½¬ä¸ºå¥³æ€§ User â™€ï¸</button>
        </div>
    </div>

    <!-- æ–‡ä»¶æ“ä½œ -->
    <div class="glass p-4 mb-4 text-center border-dashed border-2 border-white/10 hover:border-blue-500/50 transition cursor-pointer" onclick="document.getElementById('fileInput').click()" id="dropZone">
        <input type="file" id="fileInput" class="hidden" accept=".png,.json" onchange="handleFile(this.files[0])">
        <div id="fileInfo" class="py-4">
            <div class="text-2xl mb-2">ğŸ“‚</div>
            <div class="text-sm text-gray-400">ç‚¹å‡»ä¸Šä¼  PNG / JSON</div>
        </div>
    </div>

    <!-- æ‰«ææŠ¥å‘Š -->
    <div id="scanReport" class="glass p-3 mb-4 hidden bg-blue-500/10 border-blue-500/30">
        <div class="text-sm font-bold text-blue-300">ğŸ“Š æ‰«ææŠ¥å‘Š</div>
        <div id="scanDetails" class="text-xs text-gray-400 mt-1"></div>
    </div>

    <!-- æ§åˆ¶å° -->
    <div id="controlPanel" class="hidden grid grid-cols-2 gap-3 mb-4">
        <button id="pauseBtn" class="glass-input p-3 font-bold" onclick="togglePause()">â¸ï¸ æš‚åœ</button>
        <button id="retryBtn" class="glass-input p-3 font-bold text-red-400 hidden" onclick="retryFailed()">ğŸ”„ é‡è¯•å¤±è´¥é¡¹</button>
    </div>

    <button id="startBtn" class="btn-primary w-full p-4 mb-4 text-lg hidden" onclick="start()">ğŸš€ å¼€å§‹å…¨åŸŸè½¬æ¢</button>

    <!-- è¿›åº¦ -->
    <div id="progressArea" class="glass p-4 mb-4 hidden">
        <div class="flex justify-between text-xs mb-2">
            <span id="statusText">å‡†å¤‡ä¸­...</span>
            <span id="progressText">0/0</span>
        </div>
        <div class="progress-bar mb-3"><div id="bar" class="progress-fill" style="width:0%"></div></div>
        <div id="log" class="text-xs font-mono text-gray-400 max-h-60 overflow-y-auto space-y-1 pr-1"></div>
    </div>

    <!-- å¯¼å‡º -->
    <div id="exportArea" class="glass p-4 hidden">
        <h3 class="font-bold mb-3">ğŸ’¾ å¯¼å‡ºç»“æœ</h3>
        <div class="grid grid-cols-2 gap-3">
            <button class="btn-primary p-3" onclick="exportFile('png')">ä¸‹è½½ PNG</button>
            <button class="glass-input p-3" onclick="exportFile('json')">ä¸‹è½½ JSON</button>
        </div>
        <div id="diffBox" class="mt-4 text-xs bg-black/30 p-2 rounded max-h-60 overflow-y-auto whitespace-pre-wrap font-mono text-gray-400"></div>
    </div>

    <script>
        const state = {
            gender: 'male',
            orig: null,
            conv: null,
            pngBuf: null,
            fname: '',
            tasks: [],
            active: 0,
            done: 0,
            total: 0,
            paused: false
        };

        // --- æ·±åº¦æ‰«æå¼•æ“ ---
        function deepScan(data) {
            const tasks = [];
            const d = data.data || data; // å…¼å®¹ wrap

            // 1. åŸºç¡€å­—æ®µ (Core Fields)
            const coreFields = [
                'description', 'first_mes', 'scenario', 'mes_example', 
                'personality', 'system_prompt', 'post_history_instructions', 
                'depth_prompt', 'room_prototype_id'
            ];
            
            coreFields.forEach(k => {
                if (d[k] && typeof d[k] === 'string' && d[k].trim()) {
                    tasks.push({ path: [k], name: mapName(k), val: d[k], status: 'pending' });
                }
            });

            // 2. æ•°ç»„å­—æ®µ (Arrays)
            if (Array.isArray(d.alternate_greetings)) {
                d.alternate_greetings.forEach((v, i) => {
                    if (v && v.trim()) tasks.push({ path: ['alternate_greetings', i], name: `å¤‡ç”¨é—®å€™ ${i+1}`, val: v, status: 'pending' });
                });
            }
            if (Array.isArray(d.group_only_greetings)) {
                d.group_only_greetings.forEach((v, i) => {
                    if (v && v.trim()) tasks.push({ path: ['group_only_greetings', i], name: `ç¾¤èŠé—®å€™ ${i+1}`, val: v, status: 'pending' });
                });
            }

            // 3. ä¸–ç•Œä¹¦ (World Info / Character Book)
            const book = d.character_book || d.lorebook;
            if (book && book.entries && Array.isArray(book.entries)) {
                book.entries.forEach((entry, i) => {
                    if (entry.content && entry.content.trim()) {
                        const keys = entry.keys ? entry.keys.join(', ').substring(0, 15) : i;
                        tasks.push({ 
                            path: ['character_book', 'entries', i, 'content'], 
                            name: `ä¸–ç•Œä¹¦ [${keys}...]`, 
                            val: entry.content, 
                            status: 'pending' 
                        });
                    }
                });
            }

            return tasks;
        }

        function mapName(key) {
            const map = {
                'description': 'è§’è‰²æè¿°', 'first_mes': 'é¦–æ¡æ¶ˆæ¯', 'scenario': 'åœºæ™¯è®¾å®š',
                'mes_example': 'å¯¹è¯ç¤ºä¾‹', 'personality': 'æ€§æ ¼ç‰¹å¾', 'system_prompt': 'ç³»ç»Ÿæç¤ºè¯',
                'post_history_instructions': 'å†å²åæŒ‡ä»¤', 'depth_prompt': 'æ·±åº¦æç¤ºè¯'
            };
            return map[key] || key;
        }

        // --- åŸºç¡€é€»è¾‘ ---
        function setGender(g) {
            state.gender = g;
            document.getElementById('btn-male').className = `flex-1 p-3 rounded-lg border ${g==='male'?'border-blue-500 bg-blue-500/10 text-white':'bg-white/5 text-gray-400'}`;
            document.getElementById('btn-female').className = `flex-1 p-3 rounded-lg border ${g==='female'?'border-blue-500 bg-blue-500/10 text-white':'bg-white/5 text-gray-400'}`;
        }
        setGender('male');

        function toast(msg, type='info') {
            const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
            document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
        }

        // --- API ---
        async function loadModels() {
            let rawUrl = document.getElementById('apiUrl').value.trim();
            // å»é™¤æœ«å°¾æ–œæ å’Œ /chat/completions ä»¥è·å¾— Base URL
            rawUrl = rawUrl.replace(/\/\(/, '').replace(/\/chat\/completions\)/, '');
            
            const key = document.getElementById('apiKey').value.trim();
            const btn = document.getElementById('loadBtn');
            const sel = document.getElementById('modelSelect');

            if(!rawUrl || !key) return toast('è¯·å¡«å†™ URL å’Œ Key', 'error');
            
            btn.disabled = true; 
            btn.innerText = 'è¿æ¥ä¸­...';
            
            try {
                // å°è¯•è¯·æ±‚ /models
                const res = await fetch(`${rawUrl}/models`, { 
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${key}` } 
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                const list = Array.isArray(data) ? data : (data.data || []);
                
                sel.innerHTML = '';
                if (list.length === 0) throw new Error('æ¨¡å‹åˆ—è¡¨ä¸ºç©º');

                // æ’åºï¼šchat/gpt ä¼˜å…ˆ
                list.sort((a,b) => {
                    const idA = (a.id||a).toLowerCase(), idB = (b.id||b).toLowerCase();
                    return (idA.includes('gpt') || idA.includes('chat')) ? -1 : 1;
                });

                list.forEach(m => {
                    const id = m.id || m;
                    const opt = document.createElement('option'); opt.value = id; opt.innerText = id; sel.appendChild(opt);
                });
                
                sel.disabled = false;
                toast(`åŠ è½½æˆåŠŸ: ${list.length} ä¸ªæ¨¡å‹`, 'success');
                checkStart();

            } catch(e) { 
                console.error(e);
                // å¤±è´¥å…œåº•ï¼šæ‰‹åŠ¨è¾“å…¥
                sel.innerHTML = `
                    <option value="" disabled>-- åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ --</option>
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                    <option value="gpt-4o">gpt-4o</option>
                    <option value="claude-3-5-sonnet-20240620">claude-3-5-sonnet</option>
                `;
                const manual = prompt(`æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨ (${e.message})ã€‚\nè¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°ï¼š`, "gpt-3.5-turbo");
                if(manual) {
                    const opt = document.createElement('option');
                    opt.value = manual; opt.innerText = manual + " (æ‰‹åŠ¨)"; opt.selected = true;
                    sel.insertBefore(opt, sel.firstChild);
                }
                sel.disabled = false;
                checkStart();
                toast('å·²åˆ‡æ¢è‡³æ‰‹åŠ¨æ¨¡å¼', 'info');
            } finally { 
                btn.disabled = false; btn.innerText = 'ğŸ”„ åŠ è½½'; 
            }
        }

        function clearModelList() {
            document.getElementById('modelSelect').innerHTML = '<option>è¯·é‡æ–°åŠ è½½</option>';
            document.getElementById('modelSelect').disabled = true;
            checkStart();
        }

        // --- æ–‡ä»¶ ---
        const dropZone = document.getElementById('dropZone');
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#3b82f6'; };
        dropZone.ondragleave = e => { e.preventDefault(); dropZone.style.borderColor = ''; };
        dropZone.ondrop = e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); };

        function handleFile(f) {
            if (!f) return;
            state.fname = f.name.replace(/\.(png|json)$/i, '');
            const reader = new FileReader();
            if (f.name.endsWith('.json')) {
                reader.onload = e => parseData(e.target.result);
                reader.readAsText(f);
            } else {
                reader.onload = e => {
                    state.pngBuf = new Uint8Array(e.target.result);
                    const txt = extractPngText(state.pngBuf);
                    if (txt) parseData(txt); else toast('æ— æ•ˆ PNG', 'error');
                };
                reader.readAsArrayBuffer(f);
            }
        }

        function extractPngText(buf) {
            const view = new DataView(buf.buffer);
            let p = 8;
            while (p < buf.length) {
                const len = view.getUint32(p);
                const type = new TextDecoder().decode(buf.slice(p+4, p+8));
                if (type === 'tEXt' || type === 'iTXt') {
                    const data = buf.slice(p+8, p+8+len);
                    let split = data.indexOf(0);
                    const key = new TextDecoder().decode(data.slice(0, split));
                    if (key === 'chara') {
                        let txt = data.slice(split + (type==='tEXt'?1:2));
                        if(type === 'iTXt') { let i=0; while(txt[i++]!==0); while(txt[i++]!==0); txt=txt.slice(i); }
                        return new TextDecoder('utf-8').decode(txt);
                    }
                }
                p += 12 + len;
            }
            return null;
        }

        function parseData(str) {
            try {
                try { state.orig = JSON.parse(str); } catch { state.orig = JSON.parse(atob(str)); }
                
                // é¢„æ‰«æ
                state.tasks = deepScan(state.orig);
                
                const name = state.orig.data?.name || state.orig.name || 'æœªçŸ¥è§’è‰²';
                document.getElementById('fileInfo').innerHTML = `<div class="text-xl">ğŸ“„</div><div class="font-bold">${name}</div>`;
                
                // æ˜¾ç¤ºæ‰«ææŠ¥å‘Š
                const report = document.getElementById('scanDetails');
                const counts = { core: 0, book: 0, alt: 0 };
                state.tasks.forEach(t => {
                    if (t.path[0] === 'character_book') counts.book++;
                    else if (t.path[0].includes('greetings')) counts.alt++;
                    else counts.core++;
                });
                // ä¿®å¤äº†è¿™é‡Œçš„æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•
                report.innerText = `å‘ç° \({state.tasks.length} ä¸ªä»»åŠ¡ï¼šåŸºç¡€å­—æ®µ \){counts.core} | é—®å€™è¯­ \({counts.alt} | ä¸–ç•Œä¹¦ \){counts.book}`;
                document.getElementById('scanReport').classList.remove('hidden');

                checkStart();
                toast('è§£ææˆåŠŸ', 'success');
            } catch(e) { console.error(e); toast('æ ¼å¼é”™è¯¯', 'error'); }
        }

        function checkStart() {
            const ready = state.orig && !document.getElementById('modelSelect').disabled;
            const btn = document.getElementById('startBtn');
            if (ready) { btn.classList.remove('hidden'); btn.disabled = false; } else { btn.classList.add('hidden'); }
        }

        // --- è½¬æ¢ ---
        function start() {
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('controlPanel').classList.remove('hidden');
            document.getElementById('progressArea').classList.remove('hidden');
            document.getElementById('exportArea').classList.add('hidden');
            document.getElementById('log').innerHTML = '';
            document.getElementById('retryBtn').classList.add('hidden');

            state.conv = JSON.parse(JSON.stringify(state.orig));
            state.tasks = deepScan(state.conv); 
            
            state.total = state.tasks.length;
            state.done = 0;
            state.active = 0;
            state.paused = false;
            
            renderLog();
            processQueue();
        }

        function renderLog() {
            const log = document.getElementById('log');
            log.innerHTML = state.tasks.map((t, i) => `
                <div id="task-${i}" class="flex items-center justify-between p-1 hover:bg-white/5 rounded">
                    <div class="flex items-center gap-2 truncate w-full">
                        <span class="status-dot pending flex-shrink-0"></span>
                        <span class="truncate text-gray-300 text-[10px]">${t.name}</span>
                        <span class="tag">${t.path[0]==='character_book'?'ä¸–ç•Œä¹¦':(t.path[0].includes('greetings')?'é—®å€™':'åŸºç¡€')}</span>
                    </div>
                    <span class="text-[10px] opacity-50 ml-2 error-msg text-red-400"></span>
                </div>
            `).join('');
        }

        function updateStatus(idx, status, msg='') {
            state.tasks[idx].status = status;
            const el = document.getElementById(`task-${idx}`);
            if (el) {
                el.querySelector('.status-dot').className = `status-dot ${status}`;
                if (msg) el.querySelector('.error-msg').innerText = msg;
            }
            const pct = (state.done / state.total) * 100;
            document.getElementById('bar').style.width = `${pct}%`;
            // ä¿®å¤äº†è¿™é‡Œçš„æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•
            document.getElementById('progressText').innerText = `\({state.done}/\){state.total}`;
            if (state.done === state.total) finish();
        }

        function processQueue() {
            if (state.paused) return;
            if (state.done === state.total) { finish(); return; }
            const pending = state.tasks.filter(t => t.status === 'pending');
            while (state.active < 5 && pending.length > 0 && !state.paused) {
                const task = pending.shift();
                const idx = state.tasks.indexOf(task);
                runTask(task, idx);
            }
        }

        async function runTask(task, idx) {
            state.active++;
            updateStatus(idx, 'processing');
            
            // ä¿®å¤äº† URL æ„å»ºé€»è¾‘
            let url = document.getElementById('apiUrl').value.trim().replace(/\/$/, '');
            if (!url.endsWith('/chat/completions')) url += '/chat/completions';
            
            const key = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;
            const target = state.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
            
            const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¯­ä¹‰é‡æ„å¼•æ“ã€‚
ä»»åŠ¡ï¼šä¿®æ”¹æ–‡æœ¬ï¼Œå°†å…¶ä¸­ã€å±äºç”¨æˆ·({{user}})ã€‘çš„æ€§åˆ«ç‰¹å¾ä¿®æ”¹ä¸ºã€${target}ã€‘ã€‚

âš ï¸ æ ¸å¿ƒé€»è¾‘ï¼š
1. **å®ä½“è¿½è¸ª**ï¼šåˆ†ææ–‡ä¸­çš„ä»£è¯ï¼ˆä»–/å¥¹/å®ƒï¼‰å’Œåè¯ï¼Œåˆ¤æ–­æ˜¯æŒ‡ä»£è§’è‰²({{char}})è¿˜æ˜¯ç”¨æˆ·({{user}})ã€‚åªä¿®æ”¹æŒ‡ä»£ç”¨æˆ·çš„éƒ¨åˆ†ã€‚
2. **è§£å‰–å­¦é€‚é…**ï¼š
   - è‹¥ç›®æ ‡ä¸ºç”·ï¼šå°†æŒ‡ä»£ç”¨æˆ·çš„â€œä¹³æˆ¿/èŠ±ç©´/æ¹¿äº†â€ç­‰ï¼Œæ ¹æ®åŠ¨ä½œé€»è¾‘ä¿®æ”¹ä¸ºç”·æ€§çš„â€œèƒ¸è‚Œ/åç©´/è‚ æ¶²/å‰åˆ—è…ºæ¶²â€æˆ–â€œé˜´èŒ/å‹ƒèµ·â€ã€‚
   - è‹¥ç›®æ ‡ä¸ºå¥³ï¼šå°†æŒ‡ä»£ç”¨æˆ·çš„ç”·æ€§ç‰¹å¾ä¿®æ”¹ä¸ºå¥³æ€§å¯¹åº”å™¨å®˜ã€‚
   - å¿…é¡»ä¿®æ”¹ï¼Œä¸è¦å›é¿æ•æ„Ÿè¯ã€‚
3. **é£æ ¼ä¿ç•™**ï¼šä¸¥ç¦ä¿®æ”¹æ ‡ç‚¹ã€æ ¼å¼ã€Markdownã€‚ä¸æ”¹å‰§æƒ…ã€‚
4. **è¾“å‡º**ï¼šç›´æ¥è¾“å‡ºä¿®æ”¹åçš„å®Œæ•´æ–‡æœ¬ã€‚`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [ { role: 'system', content: prompt }, { role: 'user', content: task.val } ],
                        temperature: 0.3, max_tokens: 8192
                    })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    let errMsg = res.status;
                    try { errMsg += ' ' + JSON.parse(txt).error.message; } catch {}
                    throw new Error(errMsg);
                }
                
                const json = await res.json();
                const newText = json.choices[0].message.content;

                let ptr = state.conv.data || state.conv;
                if (task.path[0] === 'character_book' && !ptr.character_book && state.conv.character_book) {
                    ptr = state.conv;
                }

                for (let i = 0; i < task.path.length - 1; i++) {
                    if (ptr[task.path[i]]) ptr = ptr[task.path[i]];
                }
                ptr[task.path[task.path.length - 1]] = newText;

                updateStatus(idx, 'done');
            } catch (e) {
                console.error(e);
                updateStatus(idx, 'error', e.message);
            } finally {
                state.active--;
                state.done++;
                processQueue();
            }
        }

        function togglePause() {
            if (state.done === state.total && state.total > 0) { finish(); return; }
            state.paused = !state.paused;
            const btn = document.getElementById('pauseBtn');
            btn.innerText = state.paused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
            btn.className = state.paused ? 'glass-input p-3 font-bold bg-blue-500/20 text-blue-300' : 'glass-input p-3 font-bold';
            if (!state.paused) processQueue();
        }

        function retryFailed() {
            state.tasks.forEach((t, i) => {
                if (t.status === 'error') { t.status = 'pending'; state.done--; updateStatus(i, 'pending', ''); }
            });
            document.getElementById('retryBtn').classList.add('hidden');
            state.paused = false;
            processQueue();
        }

        function finish() {
            document.getElementById('statusText').innerText = 'å¤„ç†å®Œæˆ';
            document.getElementById('controlPanel').classList.add('hidden');
            document.getElementById('exportArea').classList.remove('hidden');
            
            const errors = state.tasks.filter(t => t.status === 'error').length;
            if (errors > 0) {
                document.getElementById('controlPanel').classList.remove('hidden');
                document.getElementById('retryBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
                toast(`${errors} ä¸ªé¡¹ç›®å¤±è´¥`, 'error');
            } else {
                const startBtn = document.getElementById('startBtn');
                startBtn.innerText = 'âœ… è½¬æ¢æˆåŠŸ (ç‚¹å‡»åˆ·æ–°)';
                startBtn.classList.remove('hidden'); startBtn.disabled = false;
                startBtn.onclick = () => location.reload();
                toast('å…¨éƒ¨å®Œæˆï¼', 'success');
            }
            
            if (!document.getElementById('controlPanel').classList.contains('hidden')) {
                 const pauseBtn = document.getElementById('pauseBtn');
                 pauseBtn.innerText = 'âœ… å®Œæˆå¹¶å¯¼å‡º';
                 pauseBtn.className = 'btn-primary p-3 font-bold';
            }

            // Diff Preview
            let diffHtml = '';
            state.tasks.forEach((t, i) => {
                let ptr = state.conv.data || state.conv;
                if (t.path[0] === 'character_book' && !ptr.character_book && state.conv.character_book) ptr = state.conv;
                for (let k = 0; k < t.path.length - 1; k++) ptr = ptr[t.path[k]];
                const newVal = ptr[t.path[t.path.length - 1]];

                if (t.status === 'done' && t.val !== newVal) {
                    // ä¿®å¤äº†è¿™é‡Œçš„æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•
                    diffHtml += `\n=== \({t.name} ===\n[åŸ]: \){t.val.substring(0, 60)}...\n[æ–°]: ${newVal.substring(0, 60)}...\n`;
                }
            });
            document.getElementById('diffBox').innerText = diffHtml || 'å†…å®¹æ— å˜åŒ–';
        }

        function exportFile(type) {
            const suffix = state.gender === 'male' ? 'MaleUser' : 'FemaleUser';
            // ä¿®å¤äº†è¿™é‡Œçš„æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•
            const name = `\({state.fname}_\){suffix}.${type}`;
            if (type === 'json') {
                const blob = new Blob([JSON.stringify(state.conv, null, 2)], {type: 'application/json'});
                save(blob, name);
            } else {
                if (!state.pngBuf) return toast('åŸå›¾ä¸¢å¤±', 'error');
                const str = JSON.stringify(state.conv);
                const b64 = btoa(unescape(encodeURIComponent(str)));
                const newBuf = packPng(state.pngBuf, b64);
                const blob = new Blob([newBuf], {type: 'image/png'});
                save(blob, name);
            }
        }

        function save(blob, name) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
        }

        function packPng(buf, text) {
            const chunks = []; let p = 8; chunks.push(buf.slice(0, 8));
            let charaInserted = false;
            const makeChunk = (t, d) => {
                const len = d.length; const b = new Uint8Array(12 + len);
                new DataView(b.buffer).setUint32(0, len); b.set(new TextEncoder().encode(t), 4); b.set(d, 8);
                const crc = calcCrc(b.slice(4, 8+len)); new DataView(b.buffer).setUint32(8+len, crc); return b;
            };
            while (p < buf.length) {
                const len = new DataView(buf.buffer).getUint32(p);
                const type = new TextDecoder().decode(buf.slice(p+4, p+8));
                if (type === 'IEND') {
                    if (!charaInserted) {
                        const key = new TextEncoder().encode('chara'); const val = new TextEncoder().encode(text);
                        const d = new Uint8Array(key.length + 1 + val.length); d.set(key); d[key.length] = 0; d.set(val, key.length+1);
                        chunks.push(makeChunk('tEXt', d));
                    }
                    chunks.push(buf.slice(p, p+12)); break;
                }
                if (type === 'tEXt' || type === 'iTXt') {
                    const d = buf.slice(p+8, p+8+len); const kEnd = d.indexOf(0);
                    const k = new TextDecoder().decode(d.slice(0, kEnd));
                    if (k === 'chara') {
                        const key = new TextEncoder().encode('chara'); const val = new TextEncoder().encode(text);
                        const data = new Uint8Array(key.length + 1 + val.length); data.set(key); data[key.length] = 0; data.set(val, key.length+1);
                        chunks.push(makeChunk('tEXt', data)); charaInserted = true; p += 12 + len; continue;
                    }
                }
                chunks.push(buf.slice(p, p+12+len)); p += 12 + len;
            }
            const total = chunks.reduce((a,c)=>a+c.length,0); const res = new Uint8Array(total);
            let off = 0; chunks.forEach(c => { res.set(c, off); off += c.length; }); return res;
        }

        const crcTable = [];
        for (let n = 0; n < 256; n++) { let c = n; for (let k = 0; k < 8; k++) c = (c & 1) ? 0xedb88320 ^ (c >>> 1) : c >>> 1; crcTable[n] = c; }
        function calcCrc(buf) { let c = 0xffffffff; for (let i = 0; i < buf.length; i++) c = crcTable[(c ^ buf[i]) & 0xff] ^ (c >>> 8); return c ^ 0xffffffff; }
    </script>
</body>
</html>
